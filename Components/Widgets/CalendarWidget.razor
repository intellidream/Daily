@using MudBlazor
@using System.Globalization

<MudStack Row="true" Spacing="6" Style="flex-wrap: wrap;" AlignItems="AlignItems.Stretch" Justify="Justify.FlexStart" Class="fill-height">
    <!-- Custom Responsive Calendar Section -->
    <div class="flex-grow-1 d-flex flex-column" style="min-width: 300px;">
        <!-- Calendar Header -->
        <div class="d-flex align-center justify-space-between mb-4 px-2">
            <div class="d-flex align-center gap-2">
                <MudText Typo="Typo.h5" Class="font-weight-bold">@_currentMonthName @_currentYear</MudText>
            </div>
            <div class="d-flex gap-2">
                 <MudTooltip Text="@(_showTimeline ? "Hide Timeline" : "Show Timeline")">
                    <MudIconButton Icon="@(_showTimeline ? Icons.Material.Filled.ViewSidebar : Icons.Material.Outlined.ViewSidebar)" 
                                  OnClick="ToggleTimeline" 
                                  Color="@(_showTimeline ? Color.Primary : Color.Default)"
                                  Size="Size.Small" />
                </MudTooltip>
                <MudIconButton Icon="@Icons.Material.Filled.ChevronLeft" OnClick="PreviousMonth" Size="Size.Small" />
                <MudIconButton Icon="@Icons.Material.Filled.ChevronRight" OnClick="NextMonth" Size="Size.Small" />
            </div>
        </div>

        <!-- Calendar Grid -->
        <MudSwipeArea OnSwipe="OnSwipe" Class="flex-grow-1" Style="width: 100%; height: 100%;">
            <div class="calendar-grid flex-grow-1">
                <!-- Day Headers -->
                @foreach (var dayName in _dayNames)
                {
                    <div class="day-header">
                        <MudText Typo="Typo.caption" Class="mud-text-secondary font-weight-bold">@dayName</MudText>
                    </div>
                }

                <!-- Empty Cells for Start Offset -->
                @for (int i = 0; i < _offsetDays; i++)
                {
                    <div class="calendar-cell empty"></div>
                }

                <!-- Day Cells -->
                @for (int day = 1; day <= _daysInMonth; day++)
                {
                    var dayNumber = day;
                    var currentDate = new DateTime(_currentYear, _currentMonth, dayNumber);
                    var isSelected = currentDate.Date == _selectedDate.Date;
                    var isToday = currentDate.Date == DateTime.Today;
                    
                    <div class="calendar-cell @(isSelected ? "selected" : (isToday ? "today-outline" : ""))" @onclick="() => SelectDate(dayNumber)">
                        <MudText Typo="Typo.body1" Class="@(isSelected || isToday ? "font-weight-bold" : "")">@dayNumber</MudText>
                    </div>
                }
            </div>
        </MudSwipeArea>
    </div>

    <!-- Timeline Section (Fixed Width Sidebar) -->
    @if (_showTimeline)
    {
        <div class="d-flex flex-column gap-2" style="width: 280px; min-width: 260px;">
            <MudPaper Elevation="0" Class="pa-0 transparent-bg flex-grow-1 d-flex flex-column">
                 <div class="d-flex align-center gap-2 mb-2 px-2 pt-2">
                    <MudIcon Icon="@Icons.Material.Filled.Timeline" Color="Color.Primary" />
                    <MudText Typo="Typo.subtitle1" Style="font-weight: 700;">@GetDayTimelineTitle()</MudText>
                </div>
                
                <MudTimeline TimelinePosition="TimelinePosition.Start" Class="px-2">
                    <MudTimelineItem Color="Color.Info" Size="Size.Small">
                        <ItemContent>
                            <MudText Typo="Typo.subtitle2" Class="mud-text-secondary mb-n1">10:00 AM</MudText>
                            <MudText Typo="Typo.body2" Class="font-weight-bold">Daily Standup</MudText>
                        </ItemContent>
                    </MudTimelineItem>
                    <MudTimelineItem Color="Color.Success" Size="Size.Small">
                        <ItemContent>
                            <MudText Typo="Typo.subtitle2" Class="mud-text-secondary mb-n1">11:30 AM</MudText>
                            <MudText Typo="Typo.body2" Class="font-weight-bold">Code Review</MudText>
                            <MudText Typo="Typo.caption">PR #402 - Auth Flow</MudText>
                        </ItemContent>
                    </MudTimelineItem>
                    <MudTimelineItem Color="Color.Warning" Size="Size.Small">
                        <ItemContent>
                            <MudText Typo="Typo.subtitle2" Class="mud-text-secondary mb-n1">01:00 PM</MudText>
                            <MudText Typo="Typo.body2" Class="font-weight-bold">Lunch Break</MudText>
                        </ItemContent>
                    </MudTimelineItem>
                    <MudTimelineItem Color="Color.Primary" Size="Size.Small">
                        <ItemContent>
                            <MudText Typo="Typo.subtitle2" Class="mud-text-secondary mb-n1">02:00 PM</MudText>
                            <MudText Typo="Typo.body2" Class="font-weight-bold">Deep Work</MudText>
                        </ItemContent>
                    </MudTimelineItem>
                    <MudTimelineItem Color="Color.Error" Size="Size.Small" Elevation="25"> 
                         <ItemContent>
                            <MudText Typo="Typo.subtitle2" Class="mud-text-secondary mb-n1">05:00 PM</MudText>
                            <MudText Typo="Typo.body2" Class="font-weight-bold">Wrap Up</MudText>
                        </ItemContent>
                    </MudTimelineItem>
                </MudTimeline>
            </MudPaper>
        </div>
    }
</MudStack>

@code {
    [Parameter] public EventCallback<bool> OnTimelineToggled { get; set; }

    private int _currentMonth = DateTime.Today.Month;
    private int _currentYear = DateTime.Today.Year;
    private int _daysInMonth;
    private int _offsetDays;
    private string _currentMonthName = "";
    private List<string> _dayNames = new();
    
    // Selection State
    private DateTime _selectedDate = DateTime.Today;
    private bool _showTimeline = true;

    protected override void OnInitialized()
    {
        var culture = CultureInfo.CurrentCulture;
        _dayNames = culture.DateTimeFormat.AbbreviatedDayNames.ToList();
        CalculateCalendar();
    }

    private async Task ToggleTimeline()
    {
        _showTimeline = !_showTimeline;
        if (OnTimelineToggled.HasDelegate)
        {
            await OnTimelineToggled.InvokeAsync(_showTimeline);
        }
    }

    private void CalculateCalendar()
    {
        _daysInMonth = DateTime.DaysInMonth(_currentYear, _currentMonth);
        _currentMonthName = CultureInfo.CurrentCulture.DateTimeFormat.GetMonthName(_currentMonth);
        
        var firstDay = new DateTime(_currentYear, _currentMonth, 1);
        _offsetDays = (int)firstDay.DayOfWeek; 
    }

    private void PreviousMonth()
    {
        var d = new DateTime(_currentYear, _currentMonth, 1).AddMonths(-1);
        _currentMonth = d.Month;
        _currentYear = d.Year;
        CalculateCalendar();
    }

    private void NextMonth()
    {
        var d = new DateTime(_currentYear, _currentMonth, 1).AddMonths(1);
        _currentMonth = d.Month;
        _currentYear = d.Year;
        CalculateCalendar();
    }

    private void SelectDate(int day)
    {
        _selectedDate = new DateTime(_currentYear, _currentMonth, day);
    }
    
    private void OnSwipe(SwipeDirection direction)
    {
        if (direction == SwipeDirection.RightToLeft)
        {
            NextMonth();
        }
        else if (direction == SwipeDirection.LeftToRight)
        {
            PreviousMonth();
        }
    }
    
    private string GetDayTimelineTitle()
    {
        if (_selectedDate.Date == DateTime.Today)
            return "Today's Timeline";
            
        return $"{_selectedDate:MMM dd} Timeline";
    }
}

<style>
    .fill-height {
        height: 100%;
    }

    .transparent-bg { background-color: transparent !important; }

    /* Custom Grid Calendar */
    .calendar-grid {
        display: grid;
        grid-template-columns: repeat(7, 1fr); /* 7 equal columns that GROW */
        grid-auto-rows: minmax(40px, auto); /* Rows are compact but can grow slightly */
        gap: 8px;
        width: 100%;
        height: auto; /* Allow height to adapt */
        min-height: auto; 
    }

    .day-header {
        text-align: center;
        padding-bottom: 8px;
        border-bottom: 1px solid rgba(255,255,255,0.1);
        margin-bottom: 4px;
    }
    
    [data-theme='light'] .day-header {
        border-bottom: 1px solid rgba(0,0,0,0.1);
    }

    .calendar-cell {
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 8px;
        /* aspect-ratio removed to allow wide rectangles */
        height: 100%; /* Fill the grid row height */
        padding: 4px; /* minimal padding */
        cursor: pointer;
        transition: all 0.2s ease;
        position: relative;
    }

    .calendar-cell:hover:not(.empty) {
        background-color: rgba(255,255,255,0.1);
    }
    
    [data-theme='light'] .calendar-cell:hover:not(.empty) {
        background-color: rgba(0,0,0,0.05);
    }

    .calendar-cell.selected {
        background-color: var(--mud-palette-primary);
        color: white;
        box-shadow: 0 4px 12px rgba(var(--mud-palette-primary-rgb), 0.4);
    }
    
    .calendar-cell.selected:hover {
        background-color: var(--mud-palette-primary-darken);
    }

    .calendar-cell.today-outline {
        border: 2px solid var(--mud-palette-primary);
        font-weight: bold;
    }
    
    .calendar-cell.empty {
        cursor: default;
        pointer-events: none;
    }
</style>