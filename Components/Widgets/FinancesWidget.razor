@using Daily.Models.Finances
@using Daily.Services.Finances
@using Daily.Services
@inject IFinancesService FinancesService
@inject IWindowManagerService WindowManager
@inject IRefreshService RefreshService
@inject NavigationManager NavManager

<!-- Widget Container -->
<div class="d-flex flex-column h-100 w-100 gap-2 cursor-pointer" @onclick="@(() => NavManager.NavigateTo("/finance"))">
    <!-- Header / Carousel -->
    <div class="d-flex align-center mb-1 flex-shrink-0" style="gap: 2px;">
         <div class="flex-grow-1" style="min-width: 0;">
             <MudCarousel TData="object" SelectedIndex="@_currentSlide" SelectedIndexChanged="@OnCarouselIndexChanged" 
                          ShowArrows="true" ShowBullets="false" AutoCycle="false" Style="height: 40px; width: 100%;" 
                          Class="flex-grow-1 rounded-pill mud-theme-primary">
                  <!-- Slide 1: Stocks -->
                  <MudCarouselItem Transition="Transition.Slide">
                      <div class="d-flex align-center justify-center h-100 px-8" style="width: 100%;">
                          <MudIcon Icon="@Icons.Material.Filled.ShowChart" Class="mr-2" Size="Size.Small" Style="color: white;" />
                          <MudText Typo="Typo.body1" Class="font-weight-bold" Style="color: white !important;">
                              Stocks
                          </MudText>
                      </div>
                  </MudCarouselItem>
                  <!-- Slide 2: Money -->
                   <MudCarouselItem Transition="Transition.Slide">
                      <div class="d-flex align-center justify-center h-100 px-8" style="width: 100%;">
                          <MudIcon Icon="@Icons.Material.Filled.AttachMoney" Class="mr-2" Size="Size.Small" Style="color: white;" />
                          <MudText Typo="Typo.body1" Class="font-weight-bold" Style="color: white !important;">
                              Money
                          </MudText>
                      </div>
                  </MudCarouselItem>
             </MudCarousel>
         </div>
         @if (HeaderAction != null)
         {
              @HeaderAction
         }
    </div>

    <!-- Content Area -->
    <div class="d-flex flex-column flex-grow-1 overflow-auto pa-1" style="scrollbar-width: none;">
        @if (_currentSlide == 0)
        {
            <!-- STOCKS VIEW -->
            if (_loading)
            {
                <div class="d-flex align-center justify-center h-100">
                    <MudProgressCircular Indeterminate="true" Size="Size.Small" Color="Color.Primary" />
                </div>
            }
            else if (_stocks.Any())
            {
                <div class="d-flex flex-column gap-1">
                    @foreach (var stock in _stocks.Take(4)) 
                    {
                        var isPositive = stock.Change >= 0;
                        var color = isPositive ? "#4CAF50" : "#F44336"; // Green / Red
                        var icon = isPositive ? Icons.Material.Filled.ArrowDropUp : Icons.Material.Filled.ArrowDropDown;
                        var bgColor = isPositive ? "rgba(76, 175, 80, 0.1)" : "rgba(244, 67, 54, 0.1)";
                        
                        <div class="d-flex align-center justify-space-between pa-2 px-3 rounded-lg flex-grow-1" style="@($"background: {bgColor}; min-height: 52px;")">
                            <div class="d-flex align-center gap-3">
                                <div class="d-flex flex-column justify-center">
                                    <MudText Typo="Typo.h6" Class="font-weight-bold" Style="line-height: 1.2;">@stock.Symbol</MudText>
                                    <MudText Typo="Typo.caption" Style="opacity: 0.7; font-size: 0.7rem;">@stock.CompanyName</MudText>
                                </div>
                            </div>
                            <div class="d-flex flex-column align-end justify-center">
                                <MudText Typo="Typo.body1" Class="font-weight-bold" Style="line-height: 1.2;">@stock.CurrentPrice.ToString("F2")</MudText>
                                <div class="d-flex align-center">
                                    <MudIcon Icon="@icon" Size="Size.Small" Style="@($"color: {color}; margin-right: -2px;")" />
                                    <MudText Typo="Typo.caption" Class="font-weight-bold" Style="@($"color: {color}; font-size: 0.75rem;")">
                                        @Math.Abs(stock.PercentChange).ToString("F2")%
                                    </MudText>
                                </div>
                            </div>
                        </div>
                    }
                </div>
            }
            else
            {
                 <div class="d-flex align-center justify-center h-100">
                    <MudText Typo="Typo.caption" Style="opacity: 0.6;">No stocks tracked</MudText>
                </div>
            }
        }
        else
        {
            <!-- MONEY VIEW -->
             <div class="d-flex flex-column align-center justify-center h-100 text-center gap-1">
                <MudText Typo="Typo.caption" Style="opacity: 0.7;">Net Worth</MudText>
                <MudText Typo="Typo.h4" Class="font-weight-bold" Color="Color.Success">@(_loading ? "..." : _netWorth.ToString("C0"))</MudText>
                
                @if (!_loading && _accounts.Any())
                {
                    <div class="d-flex gap-2 mt-2">
                         <MudChip T="string" Size="Size.Small" Variant="Variant.Outlined" Color="Color.Primary">Cash: @(_accounts.Sum(x => x.CurrentBalance).ToString("C0"))</MudChip>
                         <MudChip T="string" Size="Size.Small" Variant="Variant.Outlined" Color="Color.Secondary">Inv: @(_stocks.OfType<PortfolioItem>().Sum(x => x.TotalValue).ToString("C0"))</MudChip>
                    </div>
                }
            </div>
        }
    </div>
</div>

@code {
    [Parameter] public RenderFragment HeaderAction { get; set; }

    private int _currentSlide = 0;
    private bool _loading = false;
    private List<StockQuote> _stocks = new();
    private List<LocalAccount> _accounts = new();
    private decimal _netWorth = 0;
    
    // Default list ONLY if no holdings
    private List<string> _defaultSymbols = new() { "AAPL", "MSFT", "NVDA", "TSLA" };

    protected override async Task OnInitializedAsync()
    {
        RefreshService.RefreshRequested += RefreshData;
        await LoadData();
    }
    
    private void OnCarouselIndexChanged(int index)
    {
        _currentSlide = index;
    }
    
    private async Task RefreshData()
    {
        await LoadData();
        await InvokeAsync(StateHasChanged);
    }
    
    private async Task LoadData()
    {
        _loading = true;
        await InvokeAsync(StateHasChanged);
        
        try 
        {
            // 1. Money/NetWorth
            _netWorth = await FinancesService.GetNetWorthAsync();
            _accounts = await FinancesService.GetAccountsAsync();

            // 2. Stocks (Holdings)
            var holdings = await FinancesService.GetHoldingsWithQuotesAsync();
            if (holdings.Any())
            {
                _stocks = holdings;
            }
            else
            {
                // Fallback to defaults if empty portfolio
                _stocks = await FinancesService.GetStockQuotesAsync(_defaultSymbols);
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading finance data: {ex}");
        }
        
        _loading = false;
        await InvokeAsync(StateHasChanged);
    }
}
