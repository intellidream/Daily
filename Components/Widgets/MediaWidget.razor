@using MudBlazor
@using Microsoft.Maui.Devices
@using Daily.Services
@using Daily.Models 
@inject ISnackbar Snackbar
@inject IAuthService AuthService
@inject IYouTubeService YouTubeService
@inject IRefreshService RefreshService
@implements IDisposable

<div class="d-flex flex-column" style="height: 100%;">
    <!-- Header Section (Matches RssFeedWidget) -->
    <div class="d-flex align-center my-2 flex-grow-0" style="width: 100%; gap: 2px;">
        <div class="flex-grow-1" style="min-width: 0;">
            <MudCarousel Class="flex-grow-1 rounded-pill mud-theme-primary" ShowArrows="false" ShowBullets="false" AutoCycle="false" Style="height: 40px; width: 100%;" TData="object">
                <MudCarouselItem Transition="Transition.Slide" Color="Color.Transparent">
                     <div class="d-flex align-center justify-center h-100" style="width: 100%;">
                        <div class="d-flex align-center gap-2">
                             <MudIcon Icon="@Icons.Custom.Brands.YouTube" Size="Size.Small" Style="color: white;" />
                             <MudText Typo="Typo.caption" Class="font-weight-bold" Style="font-size: 1.1em; color: white;">YouTube</MudText>
                        </div>
                    </div>
                </MudCarouselItem>
            </MudCarousel>
        </div>

        @if (HeaderAction != null)
        {
            <div class="flex-shrink-0 d-flex align-center">
                @HeaderAction
            </div>
        }
    </div>

    @if (!_isAuthenticated)
    {
        <div class="d-flex flex-column align-center justify-center flex-grow-1 py-4">
            <MudIcon Icon="@Icons.Custom.Brands.YouTube" Color="Color.Error" Style="width: 48px; height: 48px;" Class="mb-3" />
            <MudText Typo="Typo.h6" Class="mb-1" Align="Align.Center"><b>Personalized Recommendations</b></MudText>
            <MudText Typo="Typo.body2" Class="mb-4 px-4" Align="Align.Center" Style="opacity: 0.7;">Sign in to see videos from your subscriptions and recommendations.</MudText>
            <MudButton Variant="Variant.Filled" 
                       StartIcon="@Icons.Custom.Brands.Google" 
                       Color="Color.Surface" 
                       Class="px-4"
                       Style="color: #4285F4; font-weight: bold;"
                       OnClick="LoginAsync">
                Sign in with Google
            </MudButton>
        </div>
    }
    else
    {
        <!-- Categories Chips -->
        <div class="d-flex flex-grow-0 overflow-x-auto px-0 pb-2 gap-1 mb-2 hide-scrollbar" style="white-space: nowrap; min-width: 0;">
            <MudChip T="string" Size="Size.Small" Variant="@(_selectedCategory == null ? Variant.Filled : Variant.Outlined)" Color="@(_selectedCategory == null ? Color.Primary : Color.Default)" OnClick="@(() => SelectCategory(null))">All</MudChip>
            <MudChip T="string" Size="Size.Small" Variant="@(_selectedCategory == "Latest" ? Variant.Filled : Variant.Outlined)" Color="@(_selectedCategory == "Latest" ? Color.Primary : Color.Default)" OnClick="@(() => SelectCategory("Latest"))">Latest</MudChip>
            <MudChip T="string" Size="Size.Small" Variant="@(_selectedCategory == "Tech" ? Variant.Filled : Variant.Outlined)" Color="@(_selectedCategory == "Tech" ? Color.Primary : Color.Default)" OnClick="@(() => SelectCategory("Tech"))">Tech</MudChip>
            <MudChip T="string" Size="Size.Small" Variant="@(_selectedCategory == "Podcasts" ? Variant.Filled : Variant.Outlined)" Color="@(_selectedCategory == "Podcasts" ? Color.Primary : Color.Default)" OnClick="@(() => SelectCategory("Podcasts"))">Podcasts</MudChip>
            <MudChip T="string" Size="Size.Small" Variant="@(_selectedCategory == "Music" ? Variant.Filled : Variant.Outlined)" Color="@(_selectedCategory == "Music" ? Color.Primary : Color.Default)" OnClick="@(() => SelectCategory("Music"))">Music</MudChip>
             <MudSpacer />
             <MudIconButton Icon="@Icons.Material.Filled.Logout" Color="Color.Default" OnClick="LogoutAsync" Size="Size.Small" />
        </div>

        <div class="flex-grow-1" style="height: 500px; overflow-y: auto;">
            <MudList T="string" Dense="true" Clickable="true" DisablePadding="true">
                @if (_videos == null)
                {
                    <div class="d-flex justify-center align-center" style="height: 100px; width: 100%;">
                        <MudProgressCircular Color="Color.Primary" Indeterminate="true" Size="Size.Small" />
                        <MudText Class="ml-2">Loading videos...</MudText>
                    </div>
                }
                else if (_videos.Count == 0)
                {
                     <div class="d-flex justify-center align-center" style="height: 100px; width: 100%;">
                        <MudText>No videos found.</MudText>
                    </div>
                }
                else
                {
                    @foreach (var video in _videos)
                    {
                        <MudListItem OnClick="@(() => OpenVideo(video.Url))" Class="pa-2 rounded-lg mb-1 hover-darken">
                            <div class="d-flex gap-3">
                                <!-- Thumbnail (16:9 ratio approx) -->
                                <MudImage Src="@video.ThumbnailUrl" Width="80" Height="44" ObjectFit="ObjectFit.Cover" Class="rounded-lg flex-shrink-0" />
                                
                                <div class="d-flex flex-column" style="min-width: 0; flex: 1;">
                                    <div title="@video.Title" style="width: 100%; cursor: help;">
                                        <MudText Typo="Typo.subtitle2" Style="line-height: 1.2; max-height: 2.4em; overflow: hidden; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; font-size: 0.85rem;">
                                            @video.Title
                                        </MudText>
                                    </div>
                                    <div class="d-flex align-center justify-space-between mt-1">
                                         <MudText Typo="Typo.caption" Color="Color.Secondary" Style="font-size: 0.7rem;">@video.ChannelTitle</MudText>
                                         <MudText Typo="Typo.caption" Style="font-size: 0.7rem; opacity: 0.7;">@video.Duration</MudText>
                                    </div>
                                </div>
                            </div>
                        </MudListItem>
                    }
                }
            </MudList>

            @if (_videos != null && !string.IsNullOrEmpty(_nextPageToken))
            {
                <div class="d-flex justify-center pa-2">
                    <MudButton Variant="Variant.Text" 
                               Color="Color.Primary" 
                               OnClick="LoadMore" 
                               Disabled="@_isLoadingMore"
                               FullWidth="true"
                               Size="Size.Small">
                        @if (_isLoadingMore)
                        {
                            <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2"/>
                            <MudText>Loading...</MudText>
                        }
                        else
                        {
                            <MudText>Load More</MudText>
                        }
                    </MudButton>
                </div>
            }
        </div>
    }
</div>

<style>
    .hide-scrollbar::-webkit-scrollbar { display: none; }
    .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    
    .hover-darken:hover {
        background-color: rgba(0,0,0,0.05);
    }
    
    [data-theme='dark'] .hover-darken:hover {
        background-color: rgba(255,255,255,0.05);
    }
</style>

@code {
    [Parameter] public RenderFragment? HeaderAction { get; set; }

    private bool _isAuthenticated = false;
    private List<VideoItem>? _videos;
    private string? _nextPageToken;
    private bool _isLoadingMore = false;
    private string? _selectedCategory = null;

    protected override void OnInitialized()
    {
        RefreshService.RefreshRequested += OnRefresh;
        YouTubeService.OnCategoryChanged += OnExternalCategoryChanged;
        _selectedCategory = YouTubeService.SelectedCategory;
    }

    protected override async Task OnInitializedAsync()
    {
        await CheckAuthAndLoad();
    }

    private async void OnExternalCategoryChanged(string? category)
    {
        if (_selectedCategory != category)
        {
            _selectedCategory = category;
            _videos = null; // Reload
            _nextPageToken = null;
            await InvokeAsync(StateHasChanged);

            var token = AuthService.GetProviderToken();
            if (!string.IsNullOrEmpty(token))
            {
                await LoadVideos(token, append: false);
            }
        }
    }

    private async Task OnRefresh()
    {
        var token = AuthService.GetProviderToken();
        if (!string.IsNullOrEmpty(token))
        {
            _isAuthenticated = true;
            await LoadVideos(token, append: false);
        }
        else
        {
            await CheckAuthAndLoad();
        }
        await InvokeAsync(StateHasChanged);
    }

    private async Task CheckAuthAndLoad()
    {
        var token = AuthService.GetProviderToken();
        if (!string.IsNullOrEmpty(token))
        {
            if (!_isAuthenticated) 
            {
                _isAuthenticated = true;
                await LoadVideos(token);
            }
        }
        else
        {
            // Logged out
            if (_isAuthenticated)
            {
                 _isAuthenticated = false;
                 _videos = null;
                 _nextPageToken = null;
                 _selectedCategory = null;
            }
        }
    }

    private async Task LoginAsync()
    {
        var success = await AuthService.SignInWithGoogleAsync();
        if (success)
        {
             await CheckAuthAndLoad();
             await RefreshService.TriggerDetailRefreshAsync();
        }
        else
        {
             Snackbar.Add("Login cancelled or failed", Severity.Error);
        }
    }

    private async Task LogoutAsync()
    {
        await AuthService.SignOutAsync();
        await CheckAuthAndLoad();
        await RefreshService.TriggerDetailRefreshAsync();
    }

    private async Task SelectCategory(string? category)
    {
        if (_selectedCategory == category) return;

        YouTubeService.SetCategory(category); // Sync service
        _selectedCategory = category;
        _videos = null; // Show loading state
        _nextPageToken = null;
        StateHasChanged();

        var token = AuthService.GetProviderToken();
        if (!string.IsNullOrEmpty(token))
        {
            await LoadVideos(token, append: false);
        }
    }

    private async Task LoadVideos(string token, bool append = false)
    {
        if (!append)
        {
            _videos = null; // Show full loading
            _nextPageToken = null;
            await InvokeAsync(StateHasChanged);
        }
        else
        {
            _isLoadingMore = true;
            await InvokeAsync(StateHasChanged);
        }
        
        try
        {
            // Pass the current page token and selected category
            var result = await YouTubeService.GetRecommendationsAsync(token, _nextPageToken, _selectedCategory);
            
            if (append && _videos != null)
            {
                _videos.AddRange(result.Videos);
            }
            else
            {
                // Cap initial results to 10
                _videos = result.Videos.Take(10).ToList();
            }
            
            _nextPageToken = result.NextPageToken;
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading videos: {ex.Message}");
            Snackbar.Add("Failed to load recommendations", Severity.Error);
        }
        finally
        {
            _isLoadingMore = false;
            await InvokeAsync(StateHasChanged);
        }
    }

    private async Task LoadMore()
    {
        var token = AuthService.GetProviderToken();
        if (!string.IsNullOrEmpty(token))
        {
            await LoadVideos(token, append: true);
        }
    }

    private async Task OpenVideo(string url)
    {
        await Browser.OpenAsync(url, BrowserLaunchMode.SystemPreferred);
    }

    public void Dispose()
    {
        RefreshService.RefreshRequested -= OnRefresh;
        YouTubeService.OnCategoryChanged -= OnExternalCategoryChanged;
    }
}
