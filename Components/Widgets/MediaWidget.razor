@using MudBlazor
@using Microsoft.Maui.Devices
@using Daily.Services
@using Daily.Models 
@inject ISnackbar Snackbar
@inject IAuthService AuthService
@inject IYouTubeService YouTubeService
@inject IRefreshService RefreshService
@implements IDisposable

<MudPaper Elevation="0" Class="pa-4 mb-4 glass-panel rounded-xl" Style="">
    <div class="d-flex align-center justify-space-between mb-2">
        <div class="d-flex align-center">
            <MudIcon Icon="@Icons.Custom.Brands.YouTube" Color="Color.Error" Class="mr-2" Size="Size.Large" />
            <MudText Typo="Typo.h6"><b>Recommendations</b></MudText>
        </div>
        @if (_isAuthenticated)
        {
            <MudIconButton Icon="@Icons.Material.Filled.Logout" Color="Color.Default" OnClick="LogoutAsync" Size="Size.Small" />
        }
    </div>

    @if (!_isAuthenticated)
    {
        <div class="d-flex flex-column align-center justify-center py-8">
            <MudText Typo="Typo.body1" Class="mb-4" Align="Align.Center">Sign in to get personalized video recommendations.</MudText>
            <MudButton Variant="Variant.Filled" 
                       StartIcon="@Icons.Custom.Brands.Google" 
                       Color="Color.Surface" 
                       Style="color: #4285F4; font-weight: bold;"
                       OnClick="LoginAsync">
                Sign in with Google
            </MudButton>
        </div>
    }
    else
    {
        <!-- Categories Chips -->
        <div class="d-flex flex-grow-1 overflow-x-auto px-0 pb-2 gap-1 mb-2" style="white-space: nowrap; min-width: 0;">
            <MudChip T="string" Size="Size.Small" Variant="@(_selectedCategory == null ? Variant.Filled : Variant.Outlined)" Color="@(_selectedCategory == null ? Color.Primary : Color.Default)" OnClick="@(() => SelectCategory(null))">All</MudChip>
            <MudChip T="string" Size="Size.Small" Variant="@(_selectedCategory == "Latest" ? Variant.Filled : Variant.Outlined)" Color="@(_selectedCategory == "Latest" ? Color.Primary : Color.Default)" OnClick="@(() => SelectCategory("Latest"))">Latest</MudChip>
            <MudChip T="string" Size="Size.Small" Variant="@(_selectedCategory == "Tech" ? Variant.Filled : Variant.Outlined)" Color="@(_selectedCategory == "Tech" ? Color.Primary : Color.Default)" OnClick="@(() => SelectCategory("Tech"))">Tech</MudChip>
            <MudChip T="string" Size="Size.Small" Variant="@(_selectedCategory == "Podcasts" ? Variant.Filled : Variant.Outlined)" Color="@(_selectedCategory == "Podcasts" ? Color.Primary : Color.Default)" OnClick="@(() => SelectCategory("Podcasts"))">Podcasts</MudChip>
            <MudChip T="string" Size="Size.Small" Variant="@(_selectedCategory == "Music" ? Variant.Filled : Variant.Outlined)" Color="@(_selectedCategory == "Music" ? Color.Primary : Color.Default)" OnClick="@(() => SelectCategory("Music"))">Music</MudChip>
        </div>

        <div style="height: 350px; overflow-y: auto">
            <MudList T="string" Dense="true" Clickable="true" DisablePadding="true">
                @if (_videos == null)
                {
                    <div class="d-flex justify-center align-center" style="height: 100%; width: 100%;">
                        <MudProgressCircular Color="Color.Primary" Indeterminate="true" Size="Size.Small" />
                        <MudText Class="ml-2">Loading videos...</MudText>
                    </div>
                }
                else if (_videos.Count == 0)
                {
                     <div class="d-flex justify-center align-center" style="height: 100%; width: 100%;">
                        <MudText>No videos found.</MudText>
                    </div>
                }
                else
                {
                    @foreach (var video in _videos)
                    {
                        <MudListItem OnClick="@(() => OpenVideo(video.Url))" Class="pa-2">
                            <div class="d-flex gap-3">
                                <!-- Thumbnail (16:9 ratio approx) -->
                                <MudImage Src="@video.ThumbnailUrl" Width="80" Height="44" ObjectFit="ObjectFit.Cover" Class="rounded-lg" />
                                
                                <div class="d-flex flex-column" style="min-width: 0; flex: 1;">
                                    <div title="@video.Title" style="width: 100%; cursor: help;">
                                        <MudText Typo="Typo.subtitle2" Style="line-height: 1.2; max-height: 2.4em; overflow: hidden; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical;">
                                            @video.Title
                                        </MudText>
                                    </div>
                                    <MudText Typo="Typo.caption" Color="Color.Secondary" Class="mt-1">@video.ChannelTitle</MudText>
                                    <div class="d-flex align-center mt-auto">
                                       <MudIcon Icon="@Icons.Material.Filled.AccessTime" Size="Size.Small" style="font-size: 0.75rem;" Class="mr-1"/> 
                                       <MudText Typo="Typo.caption">@video.Duration</MudText>
                                    </div>
                                </div>
                            </div>
                        </MudListItem>
                    }
                }
            </MudList>

            @if (_videos != null && !string.IsNullOrEmpty(_nextPageToken))
            {
                <div class="d-flex justify-center pa-2">
                    <MudButton Variant="Variant.Text" 
                               Color="Color.Primary" 
                               OnClick="LoadMore" 
                               Disabled="@_isLoadingMore"
                               FullWidth="true">
                        @if (_isLoadingMore)
                        {
                            <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2"/>
                            <MudText>Loading...</MudText>
                        }
                        else
                        {
                            <MudText>Load More</MudText>
                        }
                    </MudButton>
                </div>
            }
        </div>
    }
</MudPaper>

@code {
    private bool _isAuthenticated = false;
    private List<VideoItem>? _videos;
    private string? _nextPageToken;
    private bool _isLoadingMore = false;
    private string? _selectedCategory = null;

    protected override void OnInitialized()
    {
        RefreshService.RefreshRequested += OnRefresh;
    }

    protected override async Task OnInitializedAsync()
    {
        await CheckAuthAndLoad();
    }

    private async Task OnRefresh()
    {
        // Global refresh triggered (e.g. from Settings login)
        await CheckAuthAndLoad();
        StateHasChanged();
    }

    private async Task CheckAuthAndLoad()
    {
        var token = AuthService.GetProviderToken();
        if (!string.IsNullOrEmpty(token))
        {
            if (!_isAuthenticated) 
            {
                _isAuthenticated = true;
                await LoadVideos(token);
            }
        }
        else
        {
            // Logged out
            if (_isAuthenticated)
            {
                 _isAuthenticated = false;
                 _videos = null;
                 _nextPageToken = null;
                 _selectedCategory = null;
            }
        }
    }

    private async Task LoginAsync()
    {
        var success = await AuthService.SignInWithGoogleAsync();
        if (success)
        {
             await CheckAuthAndLoad();
        }
        else
        {
             Snackbar.Add("Login cancelled or failed", Severity.Error);
        }
    }

    private async Task LogoutAsync()
    {
        await AuthService.SignOutAsync();
        await CheckAuthAndLoad();
    }

    private async Task SelectCategory(string? category)
    {
        if (_selectedCategory == category) return;

        _selectedCategory = category;
        _videos = null; // Show loading state
        _nextPageToken = null;
        StateHasChanged();

        var token = AuthService.GetProviderToken();
        if (!string.IsNullOrEmpty(token))
        {
            await LoadVideos(token, append: false);
        }
    }

    private async Task LoadVideos(string token, bool append = false)
    {
        if (!append)
        {
            _videos = null; // Show full loading
            _nextPageToken = null;
            StateHasChanged();
        }
        else
        {
            _isLoadingMore = true;
            StateHasChanged();
        }
        
        try
        {
            // Pass the current page token and selected category
            var result = await YouTubeService.GetRecommendationsAsync(token, _nextPageToken, _selectedCategory);
            
            if (append && _videos != null)
            {
                _videos.AddRange(result.Videos);
            }
            else
            {
                _videos = result.Videos;
            }
            
            _nextPageToken = result.NextPageToken;
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading videos: {ex.Message}");
            Snackbar.Add("Failed to load recommendations", Severity.Error);
        }
        finally
        {
            _isLoadingMore = false;
            StateHasChanged();
        }
    }

    private async Task LoadMore()
    {
        var token = AuthService.GetProviderToken();
        if (!string.IsNullOrEmpty(token))
        {
            await LoadVideos(token, append: true);
        }
    }

    private async Task OpenVideo(string url)
    {
        await Browser.OpenAsync(url, BrowserLaunchMode.SystemPreferred);
    }

    public void Dispose()
    {
        RefreshService.RefreshRequested -= OnRefresh;
    }
}
