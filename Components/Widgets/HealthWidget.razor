@using Daily.Models.Health
@using Daily.Services.Health
@using Daily.Services
@using Microsoft.AspNetCore.Components
@inject IHealthService HealthService
<div class="d-flex align-center mb-1 flex-grow-1" style="width: 100%; gap: 2px;">
    <div class="flex-grow-1" style="min-width: 0;">
        <MudCarousel TData="object" ShowArrows="false" ShowBullets="false" AutoCycle="false" Style="height: 40px; width: 100%;" 
                     Class="flex-grow-1 rounded-pill mud-theme-primary">
             <MudCarouselItem Transition="Transition.Slide">
                 <div class="d-flex align-center justify-center h-100 px-8" style="width: 100%;">
                     <MudIcon Icon="@Icons.Material.Filled.Favorite" Class="mr-2" Size="Size.Small" Style="color: white;" />
                     <MudText Typo="Typo.body1" Class="font-weight-bold" Style="color: white !important;">
                         Vitals
                     </MudText>
                 </div>
             </MudCarouselItem>
        </MudCarousel>
    </div>
    
    @if (HeaderAction != null)
    {
        <div class="flex-shrink-0 d-flex align-center">
             @HeaderAction
        </div>
    }
</div>

<div class="d-grid gap-2 flex-grow-1" style="width: 100%; display: grid; grid-template-columns: 1fr 1fr; grid-template-rows: 1fr 1fr;">
    <!-- Steps -->
    <div class="d-flex flex-column align-center justify-center pa-2 rounded" style="background: rgba(255,255,255,0.1);">
        <MudIcon Icon="@Icons.Material.Filled.DirectionsWalk" Color="Color.Primary" Size="Size.Medium" Class="mb-1"/>
        <MudText Typo="Typo.h6" Class="font-weight-bold" Style="line-height: 1;">@(_steps > 0 ? _steps.ToString("N0") : "--")</MudText>
        <MudText Typo="Typo.caption" Style="opacity: 0.7;">Steps</MudText>
    </div>
    
    <!-- Heart Rate -->
    <div class="d-flex flex-column align-center justify-center pa-2 rounded" style="background: rgba(255,255,255,0.1);">
        <MudIcon Icon="@Icons.Material.Filled.Favorite" Color="Color.Error" Size="Size.Medium" Class="mb-1"/>
        <MudText Typo="Typo.h6" Class="font-weight-bold" Style="line-height: 1;">@(_bpm > 0 ? _bpm : "--")</MudText>
        <MudText Typo="Typo.caption" Style="opacity: 0.7;">BPM</MudText>
    </div>

    <!-- Sleep -->
    <div class="d-flex flex-column align-center justify-center pa-2 rounded" style="background: rgba(255,255,255,0.1);">
        <MudIcon Icon="@Icons.Material.Filled.Bedtime" Color="Color.Info" Size="Size.Medium" Class="mb-1"/>
        <MudText Typo="Typo.h6" Class="font-weight-bold" Style="line-height: 1;">@(_sleepHours > 0 ? _sleepHours + "h" : "--")</MudText>
        <MudText Typo="Typo.caption" Style="opacity: 0.7;">Sleep</MudText>
    </div>

    <!-- Calories -->
    <div class="d-flex flex-column align-center justify-center pa-2 rounded" style="background: rgba(255,255,255,0.1);">
        <MudIcon Icon="@Icons.Material.Filled.LocalFireDepartment" Color="Color.Warning" Size="Size.Medium" Class="mb-1"/>
        <MudText Typo="Typo.h6" Class="font-weight-bold" Style="line-height: 1;">@(_calories > 0 ? _calories.ToString("N0") : "--")</MudText>
        <MudText Typo="Typo.caption" Style="opacity: 0.7;">Kcal</MudText>
    </div>
</div>

@inject IRefreshService RefreshService
@implements IDisposable

@code {
    [Parameter] public RenderFragment HeaderAction { get; set; }

    private double _steps;
    private double _bpm;
    private double _sleepHours;
    private double _calories;

    protected override async Task OnInitializedAsync()
    {
        RefreshService.RefreshRequested += LoadData;
        await LoadData();
    }

    private async Task LoadData()
    {
        try 
        {
            await InvokeAsync(async () => 
            {
                var metrics = await HealthService.FetchMetricsAsync(DateTime.Now);
                
                var stepsMetric = metrics.FirstOrDefault(m => m.TypeString == VitalType.Steps.ToString());
                if (stepsMetric != null) _steps = stepsMetric.Value;
                else _steps = 0;

                var hrMetric = metrics.FirstOrDefault(m => m.TypeString == VitalType.HeartRate.ToString());
                if (hrMetric != null) _bpm = hrMetric.Value;
                else _bpm = 0;

                var sleepMetric = metrics.FirstOrDefault(m => m.TypeString == VitalType.SleepDuration.ToString());
                if (sleepMetric != null) _sleepHours = Math.Round(sleepMetric.Value / 60.0, 1); // Convert Min to Hours
                else _sleepHours = 0;
                
                var calMetric = metrics.FirstOrDefault(m => m.TypeString == VitalType.ActiveEnergy.ToString());
                if (calMetric != null) _calories = calMetric.Value;
                else _calories = 0;
                
                StateHasChanged();
            });
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading health: {ex}");
        }
    }

    public void Dispose()
    {
        RefreshService.RefreshRequested -= LoadData;
    }
}
