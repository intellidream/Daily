@using Daily.Models.Health
@using Daily.Services.Health
@using Daily.Services
@using Microsoft.AspNetCore.Components
@inject IHealthService HealthService
@inject IRefreshService RefreshService
@inject IWindowManagerService WindowManager

<!-- Custom CSS for Glossy/Premium Look is assumed handled by global styles or MudBlazor theme -->
<div class="d-flex flex-column h-100 w-100 gap-2">

    <!-- Header / Carousel-like Title (Matched to HabitsWidget Style) -->
    <div class="d-flex align-center mb-1 flex-shrink-0" style="gap: 2px;">
        <div class="flex-grow-1" style="min-width: 0;">
             <!-- Using MudCarousel structure to match exactly, but just one item -->
            <MudCarousel TData="object" ShowArrows="false" ShowBullets="false" AutoCycle="false" Style="height: 40px; width: 100%;" 
                         Class="flex-grow-1 rounded-pill mud-theme-primary">
                 <MudCarouselItem Transition="Transition.Slide">
                     <div class="d-flex align-center justify-center h-100 px-8" style="width: 100%;">
                         <MudIcon Icon="@Icons.Material.Filled.HealthAndSafety" Class="mr-2" Size="Size.Small" Style="color: white;" />
                         <MudText Typo="Typo.body1" Class="font-weight-bold" Style="color: white !important;">
                             Vitals
                         </MudText>
                     </div>
                 </MudCarouselItem>
            </MudCarousel>
        </div>
        @if (HeaderAction != null)
        {
             @HeaderAction
        }
    </div>

    <!-- Main Content -->
    <div class="d-flex flex-column gap-3 flex-grow-1 overflow-auto pa-1" style="scrollbar-width: none;">
        
        <!-- HERO METRICS (Radial Circles) -->
        <div class="d-flex align-center justify-space-around px-1 pt-2">
            <!-- Steps -->
            <div class="d-flex flex-column align-center relative">
                 <div style="@GetSourceDotStyle(_stepsSource); position: absolute; top: -2px; right: -2px; z-index: 10;"></div>
                 <MudProgressCircular Value="@GetPercent(_steps, 10000)" Size="Size.Medium" Color="Color.Primary" StrokeWidth="8">
                     <MudIcon Icon="@Icons.Material.Filled.DirectionsWalk" Size="Size.Small" Color="Color.Primary"/>
                 </MudProgressCircular>
                 <MudText Typo="Typo.caption" Class="mt-1" Style="font-weight:700; line-height:1;">@FormatNumber(_steps)</MudText>
            </div>
            
            <!-- Calories -->
            <div class="d-flex flex-column align-center relative">
                 <div style="@GetSourceDotStyle(_caloriesSource); position: absolute; top: -2px; right: -2px; z-index: 10;"></div>
                 <MudProgressCircular Value="@GetPercent(_calories, 2500)" Size="Size.Medium" Color="Color.Warning" StrokeWidth="8">
                     <MudIcon Icon="@Icons.Material.Filled.LocalFireDepartment" Size="Size.Small" Color="Color.Warning"/>
                 </MudProgressCircular>
                 <MudText Typo="Typo.caption" Class="mt-1" Style="font-weight:700; line-height:1;">@FormatNumber(_calories)</MudText>
            </div>

             <!-- Sleep -->
            <div class="d-flex flex-column align-center relative">
                 <div style="@GetSourceDotStyle(_sleepSource); position: absolute; top: -2px; right: -2px; z-index: 10;"></div>
                 <MudProgressCircular Value="@GetPercent(_sleepMinutes, 480)" Size="Size.Medium" Color="Color.Info" StrokeWidth="8">
                     <MudIcon Icon="@Icons.Material.Filled.Bedtime" Size="Size.Small" Color="Color.Info"/>
                 </MudProgressCircular>
                 <MudText Typo="Typo.caption" Class="mt-1" Style="font-weight:700; line-height:1;">@FormatSleep(_sleepMinutes)</MudText>
            </div>
        </div>

        <MudDivider Class="my-2" />

        <!-- SECONDARY STATS (Bubbles Style - Single Row if possible or Grid) -->
        <div class="d-flex gap-2 justify-center">
            <!-- Heart Rate -->
            <div class="d-flex flex-column align-center justify-center pa-2 rounded-xl flex-grow-1 text-center relative" style="background: rgba(255,255,255,0.05);">
                <div style="@GetSourceDotStyle(_bpmSource); position: absolute; top: 4px; right: 4px;"></div>
                <MudIcon Icon="@Icons.Material.Filled.Favorite" Color="Color.Error" Size="Size.Small"/>
                <MudText Typo="Typo.body2" Class="font-weight-bold mt-1">@(_bpm > 0 ? _bpm : "--")</MudText>
            </div>

            <!-- Weight -->
            <div class="d-flex flex-column align-center justify-center pa-2 rounded-xl flex-grow-1 text-center relative" style="background: rgba(255,255,255,0.05);">
                 <div style="@GetSourceDotStyle(_weightSource); position: absolute; top: 4px; right: 4px;"></div>
                <MudIcon Icon="@Icons.Material.Filled.MonitorWeight" Color="Color.Primary" Size="Size.Small"/>
                <MudText Typo="Typo.body2" Class="font-weight-bold mt-1">@(_weightKg > 0 ? _weightKg : "--")</MudText>
            </div>

             <!-- BP or Other -->
            <div class="d-flex flex-column align-center justify-center pa-2 rounded-xl flex-grow-1 text-center relative" style="background: rgba(255,255,255,0.05);">
                 <div style="@GetSourceDotStyle(_bpSource); position: absolute; top: 4px; right: 4px;"></div>
                <MudIcon Icon="@Icons.Material.Filled.Compress" Color="Color.Error" Size="Size.Small"/>
                <MudText Typo="Typo.body2" Class="font-weight-bold mt-1" Style="font-size: 0.8em">@GetBPString()</MudText>
            </div>
        </div>

        <!-- NUTRTION (Pills) -->
        <div class="d-flex gap-2 justify-center mt-auto pb-1">
            <MudChip T="string" Color="Color.Success" Variant="Variant.Text" Size="Size.Small" Icon="@Icons.Material.Filled.Grass">@(_carbs > 0 ? _carbs + "g" : "--")</MudChip>
            <MudChip T="string" Color="Color.Warning" Variant="Variant.Text" Size="Size.Small" Icon="@Icons.Material.Filled.Egg">@(_prot > 0 ? _prot + "g" : "--")</MudChip>
            <MudChip T="string" Color="Color.Error" Variant="Variant.Text" Size="Size.Small" Icon="@Icons.Material.Filled.OilBarrel">@(_fat > 0 ? _fat + "g" : "--")</MudChip>
        </div>

    </div>
</div>

@implements IDisposable

@code {
    [Parameter] public RenderFragment HeaderAction { get; set; }

    // Metrics
    private double _steps, _calories, _sleepMinutes;
    private double _carbs, _prot, _fat;
    private double _bpm, _distanceMeters, _weightKg;
    private double _bpSys, _bpDia;

    // Sources
    private string _stepsSource, _caloriesSource, _sleepSource;
    private string _bpmSource, _weightSource, _bpSource;


    protected override async Task OnInitializedAsync()
    {
        RefreshService.RefreshRequested += LoadDataInternal;
        await LoadDataInternal();
    }

    private async Task LoadDataInternal() => await LoadData(); // Wrapper for event handler

    private async Task LoadData()
    {
        try 
        {
            await InvokeAsync(async () => 
            {
                var metrics = await HealthService.FetchMetricsAsync(DateTime.Now);
                
                (_steps, _stepsSource) = GetValAndSource(metrics, VitalType.Steps);
                (_calories, _caloriesSource) = GetValAndSource(metrics, VitalType.ActiveEnergy); 
                (_sleepMinutes, _sleepSource) = GetValAndSource(metrics, VitalType.SleepDuration);
                
                (_bpm, _bpmSource) = GetValAndSource(metrics, VitalType.HeartRate);
                _distanceMeters = GetVal(metrics, VitalType.Distance);
                (_weightKg, _weightSource) = GetValAndSource(metrics, VitalType.Weight);
                
                double bpSys, bpDia; string bpSrc;
                (bpSys, bpSrc) = GetValAndSource(metrics, VitalType.BloodPressureSystolic);
                _bpSys = bpSys; _bpSource = bpSrc;
                _bpDia = GetVal(metrics, VitalType.BloodPressureDiastolic);

                _carbs = GetVal(metrics, VitalType.Carbs);
                _prot = GetVal(metrics, VitalType.Protein);
                _fat = GetVal(metrics, VitalType.Fat);

                StateHasChanged();
            });
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading health: {ex}");
        }
    }

    private double GetVal(List<VitalMetric> metrics, VitalType type)
    {
         var m = metrics.FirstOrDefault(x => x.TypeString == type.ToString());
         return m?.Value ?? 0;
    }

    private (double, string) GetValAndSource(List<VitalMetric> metrics, VitalType type)
    {
         var m = metrics.FirstOrDefault(x => x.TypeString == type.ToString());
         return (m?.Value ?? 0, m?.SourceDevice ?? "");
    }

    private int GetPercent(double current, double goal)
    {
        if (goal <= 0) return 0;
        var p = (int)((current / goal) * 100);
        return Math.Min(p, 100);
    }
    
    private string FormatNumber(double val)
    {
        // K number formatting (e.g. 10.5k) if > 1000
        if (val >= 1000) return (val / 1000.0).ToString("N1") + "k";
        return val > 0 ? val.ToString("N0") : "--";
    }

    private string FormatSleep(double minutes)
    {
        if (minutes <= 0) return "--";
        // e.g. 7h 30m
        var ts = TimeSpan.FromMinutes(minutes);
        return $"{ts.Hours}h {ts.Minutes}m";
    }

    private string GetBPString()
    {
        if (_bpSys > 0 && _bpDia > 0) return $"{_bpSys}/{_bpDia}";
        if (_bpSys > 0) return $"{_bpSys}/--";
        if (_bpDia > 0) return $"--/{_bpDia}";
        return "--";
    }

    private string GetSourceDotStyle(string source)
    {
        string color = "transparent"; // Default hidden if empty
        if (source == "iOS") color = "#2979FF"; // Blue
        else if (source == "Health Connect" || source == "Android") color = "#00E676"; // Green
        
        return $"width: 6px; height: 6px; border-radius: 50%; background-color: {color}; display: inline-block;";
    }

    public void Dispose()
    {
        RefreshService.RefreshRequested -= LoadDataInternal;
    }
}
