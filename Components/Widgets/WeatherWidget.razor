@using Daily.Services
@using Daily.Models
@inject IWeatherService WeatherService
@inject IGeolocation Geolocation
@inject IRefreshService RefreshService
@inject IWindowManagerService WindowManager
@inject IBackButtonService BackButtonService
@implements IDisposable

<div class="d-flex align-center mb-2 flex-grow-1" style="width: 100%; gap: 2px;">
    <div class="flex-grow-1" style="min-width: 0;">
        <MudCarousel TData="object" ShowArrows="true" ShowBullets="false" AutoCycle="false" Style="height: 40px; width: 100%;" 
                     Class="flex-grow-1 rounded-pill mud-theme-primary">
             <MudCarouselItem Transition="Transition.Slide">
                 <div class="d-flex align-center justify-center h-100 px-8" style="width: 100%;">
                     @if (_currentWeather != null)
                     {
                         <MudText Typo="Typo.body1" Class="font-weight-bold mr-2" Style="color: white !important; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                             @_currentWeather.Name
                         </MudText>
                         <!-- Assuming Auto Location since we use Geolocation -->
                         <MudIcon Icon="@Icons.Material.Filled.NearMe" Size="Size.Small" Style="color: white; opacity: 0.8;" />
                     }
                     else
                     {
                          <MudText Typo="Typo.caption" Style="color: white;">Loading...</MudText>
                     }
                 </div>
             </MudCarouselItem>
        </MudCarousel>
    </div>
    
    @if (HeaderAction != null)
    {
        <div class="flex-shrink-0 d-flex align-center">
             @HeaderAction
        </div>
    }
</div>

<MudStack Style="height: 260px; width: 100%;" Justify="Justify.SpaceBetween">
    @if (_isLoading)
    {
        <div class="d-flex justify-center align-center" style="height: 100%; width: 100%;">
            <MudProgressCircular Color="Color.Primary" Indeterminate="true" Size="Size.Small" />
            <MudText Class="ml-2">Loading weather...</MudText>
        </div>
    }
    else if (_errorMessage != null)
    {
        <MudText Color="Color.Error">@_errorMessage</MudText>
        <MudButton OnClick="@(() => LoadWeatherData(true))" Variant="Variant.Filled" Color="Color.Primary">Retry</MudButton>
    }
    else
    {
        @if (_showForecast)
        {
            @* Forecast View *@
            <MudStack Row="true" Justify="Justify.SpaceBetween" Class="px-2" Style="width: 100%; height: 100%;" AlignItems="AlignItems.Center">
                @if (_forecast != null)
                {
                    @foreach (var item in _forecast.List.Where(x => x.DtTxt.Contains("12:00:00")).Take(5))
                    {
                        <MudStack AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween" Spacing="0" Style="height: 100%; min-width: 40px;">
                            @* Top Content: Day/Date/Icon *@
                            <div class="d-flex flex-column align-center pt-5">
                                <MudText Typo="Typo.caption" Style="text-transform: uppercase; opacity: 0.9; font-weight: 700; font-size: 0.8rem;">@DateTime.Parse(item.DtTxt).ToString("ddd")</MudText>
                                <MudText Typo="Typo.caption" Style="opacity: 0.6; font-size: 0.7rem; margin-top: -2px;">@DateTime.Parse(item.DtTxt).ToString("dd MMM")</MudText>
                                <MudImage Src="@($"https://openweathermap.org/img/wn/{item.Weather[0].Icon}@4x.png")" Width="50" Height="50" Style="filter: drop-shadow(0px 2px 4px rgba(0,0,0,0.2));" />
                            </div>

                            @* Middle Content: Rain (Centered) *@
                            <div class="d-flex align-center gap-1">
                                <MudIcon Icon="@Icons.Material.Filled.WaterDrop" Size="Size.Small" Style="font-size: 0.7rem; color: #60a5fa;" />
                                <MudText Typo="Typo.caption" Style="color: #60a5fa; font-weight: 700;">@Math.Round(item.Pop * 100)%</MudText>
                            </div>
                            
                            @* Bottom Content: Temps *@
                            <div class="d-flex flex-column align-center">
                                <MudText Typo="Typo.body2" Style="font-weight: 800; font-size: 1.4rem;">@Math.Round(item.Main.TempMax)°</MudText>
                                <MudText Typo="Typo.body2" Style="opacity: 0.5; font-size: 1.0rem;">@Math.Round(item.Main.TempMin)°</MudText>
                            </div>
                        </MudStack>
                    }
                }
            </MudStack>
            
            <MudStack Row="true" Justify="Justify.FlexEnd" AlignItems="AlignItems.Center" Style="width: 100%;">
                 <MudIconButton Icon="@Icons.Material.Rounded.ArrowBack" Size="Size.Small" OnClick="@CloseForecast" Color="Color.Primary" />
            </MudStack>
        }
        else
        {
            @* Current Weather View *@
            
            @* Top Content Group *@
            <MudStack Spacing="0" Style="width: 100%;">
                
                @* Top Section: Temp & Icon *@
                <MudStack Row="true" AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween">
                    <div class="d-flex align-center pl-2 gap-4">
                        <MudText Typo="Typo.h2" Style="font-size: 3.5rem; line-height: 1;">@Math.Round(_currentWeather?.Main.Temp ?? 0)°</MudText>
                        <div class="d-flex flex-column justify-center py-1" style="height: 100%; border-left: 2px solid rgba(128,128,128, 0.2); padding-left: 14px;">
                            <MudText Typo="Typo.caption" Style="font-weight: 800; opacity: 0.6; letter-spacing: 0.5px;">FEELS LIKE</MudText>
                            <MudText Typo="Typo.h5" Style="font-weight: 600;">@Math.Round(_currentWeather?.Main.FeelsLike ?? 0)°</MudText>
                        </div>
                    </div>
                    <MudImage Src="@($"https://openweathermap.org/img/wn/{_currentWeather?.Weather[0].Icon}@4x.png")" Width="100" Height="100" Style="filter: drop-shadow(2px 4px 6px rgba(0,0,0,0.2));" />
                </MudStack>

                <MudStack Row="true" AlignItems="AlignItems.Baseline" Justify="Justify.SpaceBetween" Class="pl-2">
                    <MudText Typo="Typo.h6" Style="text-transform: capitalize; opacity: 0.9; line-height: 1; margin-bottom: 0px;">@_currentWeather?.Weather[0].Description</MudText>
                    <MudText Typo="Typo.body2" Class="pr-2" Style="opacity: 0.7; font-weight: 500;">H: @Math.Round(_currentWeather?.Main.TempMax ?? 0)° · L: @Math.Round(_currentWeather?.Main.TempMin ?? 0)°</MudText>
                </MudStack>

                <MudDivider Class="mt-4 mb-0" Style="opacity: 0.4;" />
            </MudStack>

            @* Bottom Section: Single Row Details *@
            <div class="d-flex justify-space-between px-2" style="width: 100%; height: 62px;">
                @* Sun Times *@
                <div class="d-flex flex-column align-center justify-space-between" style="height: 100%; cursor: pointer;" @onclick="ToggleSunState">
                        @if (_showSunrise)
                        {
                            <MudIcon Icon="@Icons.Material.Outlined.WbSunny" Size="Size.Medium" Style="opacity: 0.4; font-size: 1.5rem;" />
                            <div class="d-flex flex-column align-center">
                                <MudText Typo="Typo.body1" Style="font-weight: 800; line-height: 1; opacity: 0.6;">
                                    @(_currentWeather?.Sys?.Sunrise > 0 ? DateTimeOffset.FromUnixTimeSeconds(_currentWeather.Sys.Sunrise).ToLocalTime().ToString("HH:mm") : "--:--")
                                </MudText>
                                <MudText Typo="Typo.caption" Style="opacity: 0.4; font-size: 0.75rem;">Sunrise</MudText>
                            </div>
                        }
                        else
                        {
                            <MudIcon Icon="@Icons.Material.Outlined.WbTwilight" Size="Size.Medium" Style="opacity: 0.4; font-size: 1.5rem;" />
                            <div class="d-flex flex-column align-center">
                                <MudText Typo="Typo.body1" Style="font-weight: 800; line-height: 1; opacity: 0.6;">
                                    @(_currentWeather?.Sys?.Sunset > 0 ? DateTimeOffset.FromUnixTimeSeconds(_currentWeather.Sys.Sunset).ToLocalTime().ToString("HH:mm") : "--:--")
                                </MudText>
                                <MudText Typo="Typo.caption" Style="opacity: 0.4; font-size: 0.75rem;">Sunset</MudText>
                            </div>
                        }
                </div>

                @* Humidity *@
                <div class="d-flex flex-column align-center justify-space-between" style="height: 100%;">
                    <MudIcon Icon="@Icons.Material.Outlined.WaterDrop" Size="Size.Medium" Style="opacity: 0.4; font-size: 1.5rem;" />
                    <div class="d-flex flex-column align-center">
                        <MudText Typo="Typo.body1" Style="font-weight: 800; line-height: 1; opacity: 0.6;">@(_currentWeather?.Main.Humidity)%</MudText>
                        <MudText Typo="Typo.caption" Style="opacity: 0.4; font-size: 0.75rem;">Humidity</MudText>
                    </div>
                </div>

                @* Wind *@
                <div class="d-flex flex-column align-center justify-space-between" style="height: 100%;">
                    <MudIcon Icon="@Icons.Material.Outlined.Air" Size="Size.Medium" Style="opacity: 0.4; font-size: 1.5rem;" />
                    <div class="d-flex flex-column align-center">
                        <MudText Typo="Typo.body1" Style="font-weight: 800; line-height: 1; opacity: 0.6;">@Math.Round(_currentWeather?.Wind.Speed ?? 0) m/s</MudText>
                        <MudText Typo="Typo.caption" Style="opacity: 0.4; font-size: 0.75rem;">Wind</MudText>
                    </div>
                </div>

                @* Visibility *@
                <div class="d-flex flex-column align-center justify-space-between" style="height: 100%;">
                    <MudIcon Icon="@Icons.Material.Outlined.Visibility" Size="Size.Medium" Style="opacity: 0.4; font-size: 1.5rem;" />
                    <div class="d-flex flex-column align-center">
                        <MudText Typo="Typo.body1" Style="font-weight: 800; line-height: 1; opacity: 0.6;">@Math.Round((_currentWeather?.Visibility ?? 0) / 1000.0, 1) km</MudText>
                        <MudText Typo="Typo.caption" Style="opacity: 0.4; font-size: 0.75rem;">Visibility</MudText>
                    </div>
                </div>
            </div>

            <MudStack Row="true" Justify="Justify.FlexEnd" AlignItems="AlignItems.Center" Style="width: 100%;">
                <MudIconButton Icon="@Icons.Material.Rounded.ArrowForward" Size="Size.Small" OnClick="@OpenForecast" Color="Color.Primary" />
            </MudStack>
        }
    }
</MudStack>

@code {
    private bool _isLoading = true;
    private string _errorMessage;
    private WeatherResponse _currentWeather;
    private ForecastResponse _forecast;
    private bool _showForecast = false;
    private bool _showSunrise = true; // Default

    [Parameter] public RenderFragment? HeaderAction { get; set; }

    protected override async Task OnInitializedAsync()
    {
        RefreshService.RefreshRequested += HandleRefresh;
        WeatherService.OnWeatherUpdated += HandleUpdate;
        BackButtonService.Register(OnBackNative);
        await LoadWeatherData(forceRefresh: false);
    }

    public void Dispose()
    {
        BackButtonService.Unregister(OnBackNative);
        RefreshService.RefreshRequested -= HandleRefresh;
        WeatherService.OnWeatherUpdated -= HandleUpdate;
    }

    private async Task HandleRefresh()
    {
        await LoadWeatherData(forceRefresh: true);
    }

    private async void HandleUpdate()
    {
        // When updated from another source, just fetch cached data (forceRefresh=false)
        await LoadWeatherData(forceRefresh: false);
    }

    private void CloseForecast()
    {
        _showForecast = false;
        StateHasChanged();
    }
    
    private void OpenForecast()
    {
        _showForecast = true;
        StateHasChanged();
    }
    
    private bool OnBackNative()
    {
        if (_showForecast)
        {
            CloseForecast();
            return true;
        }
        return false;
    }

    private void ToggleSunState()
    {
        _showSunrise = !_showSunrise;
        StateHasChanged();
    }

    private async Task LoadWeatherData(bool forceRefresh = false)
    {
        _isLoading = true;
        _errorMessage = null;
        StateHasChanged();

        try
        {
            var location = await Geolocation.GetLastKnownLocationAsync();
            if (location == null)
            {
                location = await Geolocation.GetLocationAsync(new GeolocationRequest
                {
                    DesiredAccuracy = GeolocationAccuracy.Best,
                    Timeout = TimeSpan.FromSeconds(5)
                });
            }

            if (location != null)
            {
                var fetchWeather = WeatherService.GetCurrentWeatherAsync(location.Latitude, location.Longitude, forceRefresh);
                var fetchForecast = WeatherService.GetForecastAsync(location.Latitude, location.Longitude, forceRefresh);
                
                await Task.WhenAll(fetchWeather, fetchForecast);
                
                _currentWeather = await fetchWeather;
                _forecast = await fetchForecast;

                if (_currentWeather != null)
                {
                    // var locationName = $"{_currentWeather.Name}, {_currentWeather.Sys.Country}";
                    // await OnLocationLoaded.InvokeAsync(locationName);

                    var now = DateTimeOffset.Now.ToUnixTimeSeconds();
                    if (now > _currentWeather.Sys.Sunrise && now < _currentWeather.Sys.Sunset)
                    {
                        _showSunrise = false;
                    }
                    else
                    {
                        _showSunrise = true;
                    }
                }
            }
            else
            {
                _errorMessage = "Unable to get location.";
            }
        }
        catch (Exception ex)
        {
            _errorMessage = $"Error: {ex.Message}";
        }
        finally
        {
            _isLoading = false;
            StateHasChanged();
        }
    }
}
