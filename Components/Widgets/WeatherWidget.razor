@using Daily.Services
@using Daily.Models
@inject IWeatherService WeatherService
@inject IGeolocation Geolocation
@inject IRefreshService RefreshService
@inject IBackButtonService BackButtonService
@implements IDisposable

<MudStack Style="height: 320px; width: 100%;" Justify="Justify.SpaceBetween">
    @if (_isLoading)
    {
        <div class="d-flex justify-center align-center" style="height: 100%; width: 100%;">
            <MudProgressCircular Color="Color.Primary" Indeterminate="true" Size="Size.Small" />
            <MudText Class="ml-2">Loading weather...</MudText>
        </div>
    }
    else if (_errorMessage != null)
    {
        <MudText Color="Color.Error">@_errorMessage</MudText>
        <MudButton OnClick="LoadWeatherData" Variant="Variant.Filled" Color="Color.Primary">Retry</MudButton>
    }
    else
    {
    @if (_showForecast)
        {
            @* Forecast View *@
            <MudStack Row="true" Justify="Justify.SpaceBetween" Style="width: 100%; height: 100%;" AlignItems="AlignItems.Center">
                @if (_forecast != null)
                {
                    @foreach (var item in _forecast.List.Where(x => x.DtTxt.Contains("12:00:00")).Take(5))
                    {
                        <MudStack AlignItems="AlignItems.Center" Justify="Justify.Center" Spacing="1" Style="height: 100%; min-width: 40px;">
                            <MudImage Src="@($"https://openweathermap.org/img/wn/{item.Weather[0].Icon}@4x.png")" Width="60" Height="60" Style="filter: drop-shadow(0px 2px 4px rgba(0,0,0,0.2));" />
                            <MudText Typo="Typo.h6" Style="font-weight: bold;">@Math.Round(item.Main.Temp)°</MudText>
                            <MudText Typo="Typo.caption" Style="text-transform: uppercase; opacity: 0.7;">@DateTime.Parse(item.DtTxt).ToString("ddd")</MudText>
                        </MudStack>
                    }
                }
            </MudStack>
            
            <MudStack Row="true" Justify="Justify.FlexEnd" AlignItems="AlignItems.Center" Style="width: 100%;">
                 <MudIconButton Icon="@Icons.Material.Rounded.ArrowBack" Size="Size.Small" OnClick="@CloseForecast" Color="Color.Primary" />
            </MudStack>
        }
        else
        {
            @* Current Weather View *@
            <MudStack Spacing="1" Style="width: 100%; height: 100%;">
                
                @* Top Section: Temp & Icon *@
                <MudStack Row="true" AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween">
                    <div class="d-flex align-center pl-2 gap-4">
                        <MudText Typo="Typo.h2" Style="font-size: 3.5rem; line-height: 1;">@Math.Round(_currentWeather?.Main.Temp ?? 0)°</MudText>
                        <div class="d-flex flex-column justify-center py-1" style="height: 100%; border-left: 2px solid rgba(128,128,128, 0.2); padding-left: 14px;">
                            <MudText Typo="Typo.caption" Style="font-weight: 800; opacity: 0.6; letter-spacing: 0.5px;">FEELS LIKE</MudText>
                            <MudText Typo="Typo.h5" Style="font-weight: 600;">@Math.Round(_currentWeather?.Main.FeelsLike ?? 0)°</MudText>
                        </div>
                    </div>
                    <MudImage Src="@($"https://openweathermap.org/img/wn/{_currentWeather?.Weather[0].Icon}@4x.png")" Width="100" Height="100" Style="filter: drop-shadow(2px 4px 6px rgba(0,0,0,0.2));" />
                </MudStack>

                <MudStack Row="true" AlignItems="AlignItems.Base" Justify="Justify.SpaceBetween" Class="pl-2">
                    <MudText Typo="Typo.h6" Style="text-transform: capitalize; opacity: 0.9;">@_currentWeather?.Weather[0].Description</MudText>
                    <MudText Typo="Typo.body2" Class="pr-2" Style="opacity: 0.7; font-weight: 500;">H: @Math.Round(_currentWeather?.Main.TempMax ?? 0)° · L: @Math.Round(_currentWeather?.Main.TempMin ?? 0)°</MudText>
                </MudStack>

                <MudDivider Class="my-3" Style="opacity: 0.4;" />

                @* Bottom Section: Details Grid *@
                <MudGrid Spacing="0" Class="flex-grow-1">
                    <MudItem xs="6" Class="d-flex align-center gap-2 pa-2">
                       <MudIcon Icon="@Icons.Material.Outlined.WaterDrop" Size="Size.Small" Style="opacity: 0.7;" />
                       <div class="d-flex flex-column">
                           <MudText Typo="Typo.caption" Style="opacity: 0.6;">Humidity</MudText>
                           <MudText Typo="Typo.body2" Style="font-weight: 600;">@(_currentWeather?.Main.Humidity)%</MudText>
                       </div>
                    </MudItem>
                     <MudItem xs="6" Class="d-flex align-center gap-2 pa-2">
                       <MudIcon Icon="@Icons.Material.Outlined.Air" Size="Size.Small" Style="opacity: 0.7;" />
                       <div class="d-flex flex-column">
                           <MudText Typo="Typo.caption" Style="opacity: 0.6;">Wind</MudText>
                           <MudText Typo="Typo.body2" Style="font-weight: 600;">@Math.Round(_currentWeather?.Wind.Speed ?? 0) m/s</MudText>
                       </div>
                    </MudItem>
                     <MudItem xs="6" Class="d-flex align-center gap-2 pa-2">
                       <MudIcon Icon="@Icons.Material.Outlined.Visibility" Size="Size.Small" Style="opacity: 0.7;" />
                       <div class="d-flex flex-column">
                           <MudText Typo="Typo.caption" Style="opacity: 0.6;">Visibility</MudText>
                           <MudText Typo="Typo.body2" Style="font-weight: 600;">@((_currentWeather?.Visibility ?? 0) / 1000.0) km</MudText>
                       </div>
                    </MudItem>
                     <MudItem xs="6" Class="d-flex align-center gap-2 pa-2">
                       @* Determine if we show Sunrise or Sunset based on current time? Or just show Sunset/Sunrise icon generically *@
                       @{
                           var isDay = DateTime.Now.TimeOfDay > TimeSpan.FromHours(6) && DateTime.Now.TimeOfDay < TimeSpan.FromHours(20); // Simplified check or use Sys.Pod
                           var icon = isDay ? Icons.Material.Outlined.WbTwilight : Icons.Material.Outlined.WbSunny; // Sunset vs Sunrise icon naming is tricky
                           // Better: Use Sunset icon arrow down
                           icon = Icons.Material.Outlined.WbTwilight;
                           var label = "Sunset";
                           var time = _currentWeather?.Sys?.Sunset > 0 ? DateTimeOffset.FromUnixTimeSeconds(_currentWeather.Sys.Sunset).ToLocalTime().ToString("HH:mm") : "--:--";
                       }
                       <MudIcon Icon="@icon" Size="Size.Small" Style="opacity: 0.7;" />
                       <div class="d-flex flex-column">
                           <MudText Typo="Typo.caption" Style="opacity: 0.6;">@label</MudText>
                           <MudText Typo="Typo.body2" Style="font-weight: 600;">@time</MudText>
                       </div>
                    </MudItem>
                </MudGrid>

                <MudStack Row="true" Justify="Justify.FlexEnd" AlignItems="AlignItems.Center" Style="width: 100%;">
                    <MudIconButton Icon="@Icons.Material.Rounded.ArrowForward" Size="Size.Small" OnClick="@ShowForecast" Color="Color.Primary" />
                </MudStack>
            </MudStack>
        }
    }
</MudStack>

@code {
    private bool _isLoading = true;
    private string _errorMessage;
    private WeatherResponse _currentWeather;
    private ForecastResponse _forecast;
    private bool _showForecast = false;

    [Parameter] public EventCallback<string> OnLocationLoaded { get; set; }

    protected override async Task OnInitializedAsync()
    {
        RefreshService.RefreshRequested += LoadWeatherData;
        await LoadWeatherData();
    }

    public void Dispose()
    {
        BackButtonService.Unregister(OnBackNative);
        RefreshService.RefreshRequested -= LoadWeatherData;
    }

    private void ShowForecast()
    {
        _showForecast = true;
        BackButtonService.Register(OnBackNative);
    }

    private void CloseForecast()
    {
        _showForecast = false;
        BackButtonService.Unregister(OnBackNative);
    }

    private bool OnBackNative()
    {
        if (_showForecast)
        {
            CloseForecast();
            StateHasChanged();
            return true;
        }
        return false;
    }

    private async Task LoadWeatherData()
    {
        _isLoading = true;
        _errorMessage = null;
        StateHasChanged();

        try
        {
            var location = await Geolocation.GetLastKnownLocationAsync();
            if (location == null)
            {
                location = await Geolocation.GetLocationAsync(new GeolocationRequest
                {
                    DesiredAccuracy = GeolocationAccuracy.Best,
                    Timeout = TimeSpan.FromSeconds(30)
                });
            }

            if (location != null)
            {
                _currentWeather = await WeatherService.GetCurrentWeatherAsync(location.Latitude, location.Longitude);
                _forecast = await WeatherService.GetForecastAsync(location.Latitude, location.Longitude);

                if (_currentWeather != null)
                {
                    var locationName = $"{_currentWeather.Name}, {_currentWeather.Sys.Country}";
                    await OnLocationLoaded.InvokeAsync(locationName);
                }
            }
            else
            {
                _errorMessage = "Unable to get location.";
            }
        }
        catch (Exception ex)
        {
            _errorMessage = $"Error: {ex.Message}";
        }
        finally
        {
            _isLoading = false;
            StateHasChanged();
        }
    }
}
