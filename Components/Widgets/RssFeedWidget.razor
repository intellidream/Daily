@using MudBlazor
@using Daily.Models
@using Daily.Services
@inject IRssFeedService RssService
@inject IRefreshService RefreshService
@inject IWindowManagerService WindowManager
@inject IJSRuntime JSRuntime

<div class="d-flex align-center my-2 flex-grow-1" style="width: 100%; gap: 2px;">
    <div class="flex-grow-1" style="min-width: 0;">
        <MudCarousel TData="object" ShowArrows="true" ShowBullets="false" AutoCycle="false" Style="height: 40px; width: 100%;" 
                     SelectedIndex="@_selectedFeedIndex" SelectedIndexChanged="@OnCarouselIndexChanged" 
                     Class="flex-grow-1 rounded-pill mud-theme-primary">
            @foreach (var feed in RssService.Feeds)
            {
                <MudCarouselItem Transition="Transition.Slide">
                    <div class="d-flex align-center justify-center h-100 px-8" style="width: 100%;">
                        @if (!string.IsNullOrEmpty(feed.IconUrl))
                        {
                            <MudImage Src="@feed.IconUrl" Width="20" Height="20" Class="mr-3 flex-shrink-0" ObjectFit="ObjectFit.Contain" />
                        }
                        <div style="min-width: 0; overflow: hidden; white-space: nowrap; text-overflow: ellipsis;" class="mr-3 flex-shrink-1 text-center">
                            <MudText Typo="Typo.caption" Class="font-weight-bold" Style="font-size: 1.1em; color: white; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                                @feed.Name
                            </MudText>
                        </div>
                        <div @onclick="@(async () => await ForceRefreshFeed(feed))" @onclick:stopPropagation class="d-flex align-center justify-center rounded-circle hover-darken cursor-pointer pa-1 flex-shrink-0 ml-2">
                             <MudIcon Icon="@Icons.Material.Filled.Refresh" Size="Size.Small" Title="Refresh" Style="color: white;" />
                        </div>
                    </div>
                </MudCarouselItem>
            }
        </MudCarousel>
    </div>
    
    @if (HeaderAction != null)
    {
        <div class="flex-shrink-0 d-flex align-center">
             @HeaderAction
        </div>
    }
</div>

<div style="height: 460px; overflow: hidden; display: flex; flex-direction: column;">

    @if (RssService.IsLoading)
    {
        <div class="d-flex justify-center align-center" style="height: 100%; width: 100%;">
            <MudProgressCircular Color="Color.Primary" Indeterminate="true" Size="Size.Small" />
            <MudText Class="ml-2">Loading news...</MudText>
        </div>
    }
    else if (RssService.Error != null)
    {
        <MudAlert Severity="Severity.Error" Class="ma-2">@RssService.Error</MudAlert>
    }
    else if (RssService.Items != null && RssService.Items.Any())
    {
        <MudList T="RssItem" Clickable="true" Dense="true" DisablePadding="true" Style="flex-grow: 1; overflow-y: auto;">
            @foreach (var item in RssService.Items.Skip((_currentPage - 1) * _pageSize).Take(_pageSize))
            {
               // ... (existing list item) ...
               <MudListItem OnClick="@(() => OpenItem(item))" Style="height: 80px; overflow: hidden;" Class="px-0 py-2">
                     <div class="d-flex align-center gap-4" style="height: 100%; width: 100%;">
                        @if (!string.IsNullOrEmpty(item.ImageUrl))
                        {
                            <MudImage Src="@item.ImageUrl" Width="60" Height="60" ObjectFit="ObjectFit.Cover" Class="rounded flex-shrink-0" />
                        }
                        else if (!string.IsNullOrEmpty(RssService.CurrentFeed?.IconUrl))
                        {
                             <div class="rounded flex-shrink-0 d-flex justify-center align-center" style="width: 60px; height: 60px; background-color: var(--mud-palette-action-disabled-background);">
                                <MudImage Src="@RssService.CurrentFeed.IconUrl" Width="40" Height="40" ObjectFit="ObjectFit.Contain" />
                             </div>
                        }
                        else
                        {
                            <div class="rounded flex-shrink-0 d-flex justify-center align-center" style="width: 60px; height: 60px; background-color: var(--mud-palette-action-disabled-background);">
                                <MudIcon Icon="@Icons.Material.Filled.Article" Size="Size.Medium" />
                            </div>
                        }
                        <div style="min-width: 0; flex: 1;">
                            <div title="@item.Title" style="width: 100%; cursor: help;">
                                 <MudText Typo="Typo.body2" Style="line-height: 1.2; max-height: 2.4em; overflow: hidden; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical;">@item.Title</MudText>
                            </div>
                            <MudText Typo="Typo.caption" Style="font-size: 0.7rem; opacity: 0.8;" Class="mt-0">@item.PublishDate.ToShortDateString()</MudText>
                        </div>
                    </div>
                </MudListItem>
            }
        </MudList>

        @if (RssService.Items.Count > _pageSize)
        {
            <div class="d-flex justify-center mt-2 flex-shrink-0">
                 <MudPagination BoundaryCount="1" MiddleCount="1" Count="@_pageCount" SelectedChanged="OnPageChanged" Selected="@_currentPage" 
                                Class="pa-2" Variant="Variant.Outlined" Size="Size.Small" ShowFirstButton="false" ShowLastButton="false" />
            </div>
        }
    }
    else
    {
         <div class="d-flex justify-center align-center" style="height: 100%;">
             <MudText Color="Color.Secondary">No news items found.</MudText>
         </div>
    }
</div>

@code {
    [Parameter] public RenderFragment? HeaderAction { get; set; }

    private int _currentPage = 1;
    private const int _pageSize = 5;

    private int _pageCount => RssService.Items != null ? (int)Math.Ceiling((double)RssService.Items.Count / _pageSize) : 0;

    private int _selectedFeedIndex = 0;
    
    // Helper to sync carousel with service state
    private void SyncIndexFromService()
    {
        if (RssService.CurrentFeed != null)
        {
            var index = RssService.Feeds.IndexOf(RssService.CurrentFeed);
            if (index >= 0 && index != _selectedFeedIndex)
            {
                _selectedFeedIndex = index;
                StateHasChanged();
            }
        }
    }

    protected override async Task OnInitializedAsync()
    {
        RssService.OnItemsUpdated += async () => await InvokeAsync(StateHasChanged);
        RssService.OnFeedChanged += OnFeedChanged;
        RefreshService.RefreshRequested += OnRefreshRequested;

        // Initial sync
        SyncIndexFromService();

        // If service is empty (first load), trigger load
        if (RssService.Items.Count == 0 && RssService.CurrentFeed != null)
        {
             await RssService.ReloadCurrentFeedAsync();
        }
    }

    public void Dispose()
    {
        RssService.OnItemsUpdated -= StateHasChanged;
        RssService.OnFeedChanged -= OnFeedChanged;
        RefreshService.RefreshRequested -= OnRefreshRequested;
    }

    private async void OnFeedChanged()
    {
        _currentPage = 1;
        SyncIndexFromService();
        await InvokeAsync(StateHasChanged);
    }
    
    private void OnCarouselIndexChanged(int index)
    {
        _selectedFeedIndex = index;
        if (index >= 0 && index < RssService.Feeds.Count)
        {
            var feed = RssService.Feeds[index];
            if (RssService.CurrentFeed != feed)
            {
                RssService.SelectFeed(feed);
            }
        }
    }

    private void OnPageChanged(int page)
    {
        _currentPage = page;
        StateHasChanged();
    }

    private async Task ForceRefreshFeed(FeedSource feed)
    {
        RssService.SelectFeed(feed);
        await RssService.LoadFeedAsync(feed, true);
    }

    private async Task OnRefreshRequested()
    {
        await RssService.ReloadCurrentFeedAsync();
    }

    private void OpenItem(RssItem item)
    {
        WindowManager.OpenDetail("RssFeed", item.Title, item);
    }
}

<style>
    .rss-chip {
        border: none;
        color: var(--mud-palette-text-primary);
        background-color: rgba(0,0,0,0.08);
        transition: all 0.3s ease;
    }
    .rss-chip.selected {
        background-color: var(--mud-palette-primary) !important;
        color: var(--mud-palette-primary-text) !important;
    }
    
    .rss-chip:hover {
        opacity: 0.8;
    }

    body[data-theme='dark'] .rss-chip {
        background-color: var(--mud-palette-action-disabled-background);
    }
</style>
