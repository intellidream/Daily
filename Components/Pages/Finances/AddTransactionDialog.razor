@using MudBlazor
@using Daily.Models.Finances
@using Daily.Services.Finances
@inject IFinancesService FinancesService
@inject ISnackbar Snackbar

<MudDialog>
    <DialogContent>
        <MudForm @ref="_form">
            <MudSelect T="LocalAccount" Label="Account" @bind-Value="_selectedAccount" Required="true" ToStringFunc="@(a => a?.Name)">
                @foreach (var account in _accounts)
                {
                    <MudSelectItem Value="@account">@account.Name (@account.CurrentBalance.ToString("C0"))</MudSelectItem>
                }
            </MudSelect>

            <MudNumericField Label="Amount" @bind-Value="_amount" Format="F2" HelperText="Positive for Income, Negative for Expense" />
            
            <MudDatePicker Label="Date" @bind-Date="_date" />
            
            <MudTextField Label="Category" @bind-Value="_category" />
            <MudTextField Label="Description" @bind-Value="_description" Lines="2" />
        </MudForm>
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="Cancel" Disabled="@_processing">Cancel</MudButton>
        <MudButton Color="Color.Primary" OnClick="Submit" Disabled="@_processing">
             @if (_processing)
            {
                <MudProgressCircular Class="ms-n1" Size="Size.Small" Indeterminate="true"/>
                <MudText Class="ms-2">Saving...</MudText>
            }
            else
            {
                <MudText>Save</MudText>
            }
        </MudButton>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter] IMudDialogInstance MudDialog { get; set; }
    
    private MudForm _form;
    private List<LocalAccount> _accounts = new();
    private LocalAccount _selectedAccount;
    private decimal _amount;
    private DateTime? _date = DateTime.Today;
    private string _category;
    private string _description;
    private bool _processing = false;

    protected override async Task OnInitializedAsync()
    {
        _accounts = await FinancesService.GetAccountsAsync();
        if (_accounts.Any()) _selectedAccount = _accounts.First();
    }

    private void Cancel() => MudDialog.Cancel();

    private async Task Submit()
    {
        if (_processing) return;
        
        try 
        {
            await _form.Validate();
            if (_form.IsValid)
            {
                if (_selectedAccount == null) return;
                
                _processing = true;
                StateHasChanged();

                var transaction = new LocalTransaction
                {
                    AccountId = _selectedAccount.Id,
                    Amount = _amount,
                    Date = _date ?? DateTime.Now,
                    Category = _category,
                    Description = _description
                };

                await FinancesService.AddTransactionAsync(transaction);
                
                _processing = false;
                MudDialog.Close(DialogResult.Ok(transaction));
            }
        }
        catch (Exception ex)
        {
            _processing = false;
            Console.WriteLine($"[AddTransactionDialog] Error: {ex}");
            Snackbar.Add($"Error saving transaction: {ex.Message}", Severity.Error);
            StateHasChanged();
        }
    }
}
