@page "/finances"
@using Daily.Models.Finances
@using Daily.Services.Finances
@using Daily.Services
@inject IFinancesService FinancesService
@inject IRefreshService RefreshService
@implements IDisposable

<div class="d-flex flex-column h-100 pb-4" style="overflow-y: auto;">
    
    @if (_loading)
    {
         <MudProgressLinear Color="Color.Primary" Indeterminate="true" Class="rounded-lg mb-4" />
    }

    @if (FinancesService.CurrentViewType == "Stocks")
    {
         <MudPaper Class="detail-tile rounded-xl pa-4 relative" Elevation="3">
             <div class="d-flex align-center justify-space-between mb-4">
                 <MudText Typo="Typo.h6" Class="font-weight-bold">Watchlist</MudText>
                 <MudChip T="string" Size="Size.Small" Color="Color.Surface" Variant="Variant.Outlined">US Market (Delayed)</MudChip>
             </div>
             
             @if (_stocks.Any())
             {
                 <div class="d-flex flex-column gap-3 mt-2">
                     @foreach (var stock in _stocks)
                     {
                         var isPositive = stock.Change >= 0;
                         var color = isPositive ? Color.Success : Color.Error;
                         var icon = isPositive ? Icons.Material.Filled.ArrowDropUp : Icons.Material.Filled.ArrowDropDown;
                         var bgClass = isPositive ? "success-glass" : "error-glass"; // We will style this inline for simplicity or reuse existing
                         var bgStyle = isPositive ? "background: rgba(76, 175, 80, 0.05); border: 1px solid rgba(76, 175, 80, 0.2);" : "background: rgba(244, 67, 54, 0.05); border: 1px solid rgba(244, 67, 54, 0.2);";
                         
                         <MudPaper Class="d-flex align-center justify-space-between pa-4 rounded-xl cursor-pointer hover-zoom" 
                                   Elevation="0" Style="@bgStyle">
                             
                             <!-- Left: Symbol & Name -->
                             <div class="d-flex align-center gap-4">
                                 @if (!string.IsNullOrEmpty(stock.LogoUrl))
                                 {
                                     <MudPaper Class="d-flex align-center justify-center rounded overflow-hidden mr-4" Width="40px" Height="40px" Elevation="0" Style="background-color: white;">
                                         <MudImage Src="@stock.LogoUrl" Width="32" Height="32" ObjectFit="ObjectFit.Contain" />
                                     </MudPaper>
                                 }
                                 else
                                 {
                                     <MudAvatar Color="Color.Surface" Variant="Variant.Filled" Rounded="true" Class="mr-4">
                                         @stock.Symbol.Substring(0, 1)
                                     </MudAvatar>
                                 }
                                 
                                 <div class="d-flex flex-column">
                                     <MudText Typo="Typo.h6" Class="font-weight-bold" Style="line-height: 1.1;">@stock.Symbol</MudText>
                                     <MudText Typo="Typo.body2" Style="opacity: 0.6;">@stock.CompanyName</MudText>
                                 </div>
                             </div>
                             
                             <!-- Right: Price & Change -->
                             <div class="d-flex align-center gap-4">
                                 <div class="d-flex flex-column align-end">
                                     <MudText Typo="Typo.h6" Class="font-weight-bold">@stock.CurrentPrice.ToString("F2")</MudText>
                                     <MudText Typo="Typo.caption" Style="opacity: 0.6;">Price</MudText>
                                 </div>
                                 
                                 <MudChip T="string" Size="Size.Medium" Variant="Variant.Filled" Color="@color" Class="px-3" Icon="@icon">
                                      <MudText Typo="Typo.body2" Class="font-weight-bold ml-1">
                                          @(stock.PercentChange > 0 ? "+" : "")@stock.PercentChange.ToString("F2")%
                                      </MudText>
                                 </MudChip>
                             </div>
                         </MudPaper>
                     }
                 </div>
             }
             else
             {
                 <MudText Typo="Typo.body2" Style="opacity: 0.6;" Class="ma-4">No stocks tracked.</MudText>
             }
         </MudPaper> 
    }
    else
    {
        <!-- MONEY / CURRENCY (Placeholder) -->
        <MudPaper Class="detail-tile rounded-xl pa-6 d-flex flex-column align-center justify-center text-center relative h-100" Elevation="3" 
                  Style="min-height: 400px; background: rgba(255,193,7, 0.05); border: 1px dashed rgba(255,193,7, 0.3);">
            
             <MudIcon Icon="@Icons.Material.Filled.Construction" Size="Size.Large" Color="Color.Warning" Class="mb-4" />
             
             <MudText Typo="Typo.h6" Class="font-weight-bold" Color="Color.Warning">Money Manager</MudText>
             <MudText Typo="Typo.body2" Class="mt-2" Style="opacity: 0.7;">
                 Currency Exchange & Wallet
             </MudText>
             
             <MudChip T="string" Class="mt-4" Size="Size.Small" Variant="Variant.Outlined" Color="Color.Warning">COMING SOON</MudChip>
        </MudPaper>
    }
</div>

@code {
    private bool _loading = false;
    private List<StockQuote> _stocks = new();
    
    // Default list
    private List<string> _trackedSymbols = new() { "AAPL", "MSFT", "NVDA", "TSLA", "GOOGL", "AMZN", "META", "NFLX" };

    protected override async Task OnInitializedAsync()
    {
        RefreshService.DetailRefreshRequested += RefreshData;
        FinancesService.OnViewTypeChanged += OnViewTypeChanged;
        
        // Initial load
        await LoadStocks();
    }
    
    private void OnViewTypeChanged()
    {
        StateHasChanged();
    }
    
    private async Task RefreshData()
    {
        await LoadStocks();
        await InvokeAsync(StateHasChanged);
    }
    
    private async Task LoadStocks()
    {
        // Only show loading if we really need to, maybe unnecessary for view switching if data is cached (future)
        // For now, keep it simple
        _loading = true;
        await InvokeAsync(StateHasChanged);
        
        try 
        {
            _stocks = await FinancesService.GetStockQuotesAsync(_trackedSymbols);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading stock details: {ex}");
        }
        
        _loading = false;
        await InvokeAsync(StateHasChanged);
    }
    
    public void Dispose()
    {
        RefreshService.DetailRefreshRequested -= RefreshData;
        FinancesService.OnViewTypeChanged -= OnViewTypeChanged;
    }
}
