@using Daily.Services
@using Daily.Components.Pages
@inject IWindowManagerService WindowManager
@inject IJSRuntime JSRuntime
@inject IRefreshService RefreshService
@inject IDetailNavigationService NavService
@inject ISnackbar Snackbar
@implements IDisposable

<MudThemeProvider @bind-IsDarkMode="_isDarkMode" Theme="_theme" />
<MudDialogProvider />
<MudSnackbarProvider />
<MudPopoverProvider />

<MudLayout Style="background-color: transparent; min-height: 100vh; display: flex; flex-direction: column;">
    <MudAppBar Elevation="0" Dense="true" Fixed="true" Color="Color.Transparent" Class="@AppBarClass" Style="backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); border-bottom: 1px solid rgba(255,255,255,0.1);">
        @if (!string.IsNullOrEmpty(NavService.CurrentArticleLink))
        {
            <MudIconButton Icon="@Icons.Material.Filled.ArrowBack" Color="Color.Inherit" OnClick="@(() => NavService.SetCurrentArticleLink(null))" Class="mr-2" />
        }
        else
        {
            <MudIconButton Icon="@Icons.Material.Filled.Refresh" Color="Color.Inherit" OnClick="@(async () => await RefreshService.TriggerDetailRefreshAsync())" Class="mr-2" />
        }

        <MudText Typo="Typo.h6"><b>@NavService.CurrentTitle</b></MudText>
        <MudSpacer />
        
        @if (!string.IsNullOrEmpty(NavService.CurrentArticleLink))
        {
            <MudTooltip Text="Read full article">
                <MudIconButton Icon="@Icons.Material.Filled.Web" Color="Color.Inherit" OnClick="OpenInternalBrowser" Class="mr-2" />
            </MudTooltip>
            <MudTooltip Text="Copy Link">
                <MudIconButton Icon="@Icons.Material.Filled.ContentCopy" Color="Color.Inherit" OnClick="CopyToClipboard" />
            </MudTooltip>
            <MudTooltip Text="Open in System Browser">
                <MudIconButton Icon="@Icons.Material.Filled.OpenInNew" Color="Color.Inherit" OnClick="OpenSystemBrowser" />
            </MudTooltip>
        }

        <MudIconButton Icon="@Icons.Material.Filled.Close" Color="Color.Inherit" OnClick="@(() => WindowManager.CloseDetailWindow())" Title="Close" />
    </MudAppBar>
    <MudMainContent Class="d-flex flex-column" Style="flex-grow: 1;">
        <MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="@ContainerClass" Style="flex-grow: 1; display: flex; flex-direction: column;">
            @if (NavService.CurrentView == "SystemInfo")
            {
                <SystemInfoDetail />
            }
            else if (NavService.CurrentView == "RssFeed")
            {
                <RssFeedDetail />
            }
            else
            {
                <MudPaper Class="pa-8 glass-panel" Elevation="0" Style="min-height: 80vh;">
                    <MudText Typo="Typo.h4" GutterBottom="true">Reading Pane</MudText>
                    <MudText Typo="Typo.body1">This is the dedicated large format view for reading articles and watching content.</MudText>
                    <MudAlert Severity="Severity.Info" Class="mt-4">Select content from the main window to view it here.</MudAlert>
                </MudPaper>
            }
        </MudContainer>
    </MudMainContent>
</MudLayout>

@code {
    private bool _isDarkMode = true;
    private MudTheme _theme = new()
    {
        PaletteLight = new PaletteLight
        {
            Background = "#00000000",
            AppbarBackground = "#00000000",
            DrawerBackground = "#00000000",
            Surface = "#00000000"
        },
        PaletteDark = new PaletteDark
        {
            Background = "#00000000",
            AppbarBackground = "#00000000",
            DrawerBackground = "#00000000",
            Surface = "#00000000"
        }
    };

    private string AppBarClass { get; set; } = "";
    private string ContainerClass { get; set; } = "";

    protected override void OnInitialized()
    {
        if (Application.Current != null)
        {
            Application.Current.RequestedThemeChanged += OnThemeChanged;
            _isDarkMode = Application.Current.RequestedTheme == AppTheme.Dark;
        }

        NavService.OnViewChanged += StateHasChanged;
        NavService.OnArticleLinkChanged += OnArticleLinkChanged;

        if (Microsoft.Maui.Devices.DeviceInfo.Platform == Microsoft.Maui.Devices.DevicePlatform.Android ||
            Microsoft.Maui.Devices.DeviceInfo.Platform == Microsoft.Maui.Devices.DevicePlatform.iOS)
        {
            // Mobile Layout
            AppBarClass = "pt-20 pb-2";
            ContainerClass = "mt-20 py-6 px-4";
        }
        else
        {
            // Desktop Layout (Windows/Mac)
            AppBarClass = "pt-20 pb-2";
            ContainerClass = "mt-20 py-8 px-6";
        }
    }

    private async void OnThemeChanged(object? sender, AppThemeChangedEventArgs e)
    {
        _isDarkMode = e.RequestedTheme == AppTheme.Dark;
        StateHasChanged();
        await UpdateThemeJs();
    }

    private async Task UpdateThemeJs()
    {
        var themeValue = _isDarkMode ? "dark" : "light";
        await JSRuntime.InvokeVoidAsync("eval", $"document.body.setAttribute('data-theme', '{themeValue}')");
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await JSRuntime.InvokeVoidAsync("document.body.classList.add", "mesh-background");
            await UpdateThemeJs();
        }
    }

    public void Dispose()
    {
        NavService.OnViewChanged -= StateHasChanged;
        NavService.OnArticleLinkChanged -= StateHasChanged;
        if (Application.Current != null)
        {
            Application.Current.RequestedThemeChanged -= OnThemeChanged;
        }
    }

    private void OnArticleLinkChanged()
    {
        StateHasChanged();
    }

    private async Task CopyToClipboard()
    {
        var url = NavService.CurrentArticleLink;
        if (!string.IsNullOrEmpty(url))
        {
            await Clipboard.Default.SetTextAsync(url);
            Snackbar.Add("Link copied to clipboard", Severity.Success);
        }
    }

    private void OpenInternalBrowser()
    {
        var url = NavService.CurrentArticleLink;
        if (!string.IsNullOrEmpty(url))
        {
            NavService.RequestOpenUrl(url);
        }
    }

    private async Task OpenSystemBrowser()
    {
        var url = NavService.CurrentArticleLink;
        if (!string.IsNullOrEmpty(url))
        {
            try
            {
                await Launcher.Default.OpenAsync(new Uri(url));
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error opening system browser: {ex.Message}");
            }
        }
    }
}
