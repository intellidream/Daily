@using Daily.Services
@using Daily.Components.Pages
@inject IWindowManagerService WindowManager
@inject IJSRuntime JSRuntime
@inject IRefreshService RefreshService
@inject IDetailNavigationService NavService
@inject ISnackbar Snackbar
@inject IRssFeedService RssService
@inject IWeatherService WeatherService
@implements IDisposable

<MudThemeProvider @bind-IsDarkMode="_isDarkMode" Theme="_theme" />
<MudDialogProvider />
<MudSnackbarProvider />
<MudPopoverProvider />

<MudLayout Style="background-color: transparent; min-height: 100vh; display: flex; flex-direction: column;" Class="mesh-background" UserAttributes="@(new Dictionary<string, object> { { "data-theme", _isDarkMode ? "dark" : "light" } })">
    <MudAppBar Elevation="0" Dense="true" Fixed="true" Color="Color.Transparent" Class="@AppBarClass" Style="backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); border-bottom: 1px solid rgba(255,255,255,0.1);">
        @if (!string.IsNullOrEmpty(NavService.CurrentArticleLink))
        {
            <MudIconButton Icon="@Icons.Material.Filled.ArrowBack" Edge="@_startEdge" Color="Color.Inherit" OnClick="@(() => NavService.SetCurrentArticle(null))" Class="mr-2" />
        }
        else
        {
            <MudIconButton Icon="@Icons.Material.Filled.Refresh" Edge="@_startEdge" Color="Color.Inherit" OnClick="@(async () => await RefreshService.TriggerDetailRefreshAsync())" Class="mr-2" />
        }

        @if (!string.IsNullOrEmpty(NavService.CurrentArticleLink))
        {
             <div style="flex: 1; min-width: 0;">
                 <MudText Typo="Typo.h6" Style="white-space: nowrap; overflow: hidden; text-overflow: ellipsis; font-weight: 700;">
                     @NavService.CurrentArticleTitle
                 </MudText>
             </div>
        }
         else if (NavService.CurrentView == "RssFeed" && RssService.CurrentFeed != null)
         {
              <div class="d-flex align-center flex-grow-1 position-relative ml-2 mr-4" style="min-width: 0; height: 100%;">
                  <MudCarousel TData="object" ShowArrows="true" ShowBullets="false" AutoCycle="false" Style="height: 40px; width: 100%;" 
                               SelectedIndex="@_selectedFeedIndex" SelectedIndexChanged="@OnCarouselIndexChanged" 
                               Class="flex-grow-1 rounded-pill mud-theme-primary">
                      @foreach (var feed in RssService.Feeds)
                      {
                          <MudCarouselItem Transition="Transition.Slide">
                              <div class="d-flex align-center justify-center h-100 px-8" style="width: 100%;">
                                  @if (!string.IsNullOrEmpty(feed.IconUrl))
                                  {
                                      <MudImage Src="@feed.IconUrl" Width="20" Height="20" Class="mr-3 flex-shrink-0" ObjectFit="ObjectFit.Contain" />
                                  }
                                  
                                  <div style="min-width: 0; overflow: hidden; white-space: nowrap; text-overflow: ellipsis;" class="mr-3 flex-shrink-1 text-center">
                                      <MudText Typo="Typo.body1" Class="font-weight-bold" Style="color: white !important; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                                          @feed.Name
                                      </MudText>
                                  </div>
                                  
                                  @if (RssService.Items != null && RssService.CurrentFeed == feed)
                                  {
                                      <MudChip T="string" Size="Size.Small" Variant="Variant.Text" Color="Color.Inherit" Class="ml-2 my-0 py-0 flex-shrink-0" style="height: 20px; font-size: 0.8em; color: white !important;">
                                          @RssService.Items.Count
                                      </MudChip>
                                  }
                              </div>
                          </MudCarouselItem>
                      }
                  </MudCarousel>
              </div>
         }
         else if (NavService.CurrentView == "Media")
         {
              <!-- Media Carousel (YouTube only for now) -->
              <div class="d-flex align-center flex-grow-1 position-relative ml-2 mr-4" style="min-width: 0; height: 100%;">
                  <MudCarousel TData="object" ShowArrows="false" ShowBullets="false" AutoCycle="false" Style="height: 40px; width: 100%;" 
                               Class="flex-grow-1 rounded-pill mud-theme-primary">
                          <MudCarouselItem Transition="Transition.Slide">
                              <div class="d-flex align-center justify-center h-100 px-8" style="width: 100%;">
                                  <MudIcon Icon="@Icons.Custom.Brands.YouTube" Class="mr-3 flex-shrink-0" />
                                  <div style="min-width: 0; overflow: hidden; white-space: nowrap; text-overflow: ellipsis;" class="flex-shrink-1 text-center">
                                      <MudText Typo="Typo.body1" Class="font-weight-bold" Style="color: white !important;">
                                          YouTube
                                      </MudText>
                                  </div>
                              </div>
                          </MudCarouselItem>
                  </MudCarousel>
              </div>
         }
         else if (NavService.CurrentView == "Weather")
         {
              <!-- Weather Location Carousel -->
              <div class="d-flex align-center flex-grow-1 position-relative ml-2 mr-4" style="min-width: 0; height: 100%;">
                  <MudCarousel TData="object" ShowArrows="true" ShowBullets="false" AutoCycle="false" Style="height: 40px; width: 100%;" 
                               Class="flex-grow-1 rounded-pill mud-theme-primary">
                          <MudCarouselItem Transition="Transition.Slide">
                              <div class="d-flex align-center justify-center h-100 px-8" style="width: 100%;">
                                  @if (!string.IsNullOrEmpty(WeatherService.CurrentLocationName))
                                  {
                                      <MudText Typo="Typo.body1" Class="font-weight-bold mr-2" Style="color: white !important; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                                          @WeatherService.CurrentLocationName
                                      </MudText>
                                      @if (WeatherService.IsAutoLocation)
                                      {
                                           <MudIcon Icon="@Icons.Material.Filled.NearMe" Size="Size.Small" Style="color: white; opacity: 0.8;" />
                                      }
                                      else
                                      {
                                           <MudIcon Icon="@Icons.Material.Filled.Favorite" Size="Size.Small" Style="color: white; opacity: 0.8;" />
                                      }
                                  }
                                  else
                                  {
                                       <MudProgressCircular Size="Size.Small" Indeterminate="true" Color="Color.Inherit" />
                                  }
                              </div>
                          </MudCarouselItem>
                  </MudCarousel>
              </div>
         }
        else
        {
            <MudText Typo="Typo.h6"><b>@NavService.CurrentTitle</b></MudText>
            <MudSpacer />
        }
        
        @if (!string.IsNullOrEmpty(NavService.CurrentArticleLink))
        {
                <MudTooltip Text="@(NavService.IsBrowserOpen ? "Return to Reader" : "Read original article")">
                     <MudIconButton Icon="@Icons.Material.Filled.Web" Color="@(NavService.IsBrowserOpen ? Color.Primary : Color.Inherit)" OnClick="ToggleBrowser" Class="mr-2" />
                </MudTooltip>

                <MudTooltip Text="Open in System Browser">
                     <MudIconButton Icon="@Icons.Material.Filled.Public" Color="Color.Inherit" OnClick="OpenSystemBrowser" Class="mr-2" />
                </MudTooltip>

                 <MudTooltip Text="Copy Link">
                    <MudIconButton Icon="@Icons.Material.Filled.ContentCopy" Color="Color.Inherit" OnClick="CopyToClipboard" />
                </MudTooltip>
        }

        <MudIconButton Icon="@Icons.Material.Filled.OpenInNew" Edge="@_endEdge" Color="Color.Inherit" OnClick="@(() => WindowManager.CloseDetailWindow())" Title="Close" Style="transform: scaleY(-1);" />
    </MudAppBar>
    <MudMainContent Class="d-flex flex-column" Style="flex-grow: 1;">
        <MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="@ContainerClass" Style="flex-grow: 1; display: flex; flex-direction: column;">
            @if (NavService.CurrentView == "SystemInfo")
            {
                <SystemInfoDetail />
            }
            else if (NavService.CurrentView == "RssFeed")
            {
                <RssFeedDetail />
            }
            else if (NavService.CurrentView == "Media")
            {
                <MediaDetail />
            }
            else if (NavService.CurrentView == "Weather")
            {
                <WeatherDetail />
            }
            else if (NavService.CurrentView == "Settings")
            {
                <Settings />
            }
            else
            {
                <MudPaper Class="pa-8 glass-panel rounded-xl" Elevation="0" Style="min-height: 80vh;">
                    <MudText Typo="Typo.h4" GutterBottom="true">Reading Pane</MudText>
                    <MudText Typo="Typo.body1">This is the dedicated large format view for reading articles and watching content.</MudText>
                    <MudAlert Severity="Severity.Info" Class="mt-4">Select content from the main window to view it here.</MudAlert>
                </MudPaper>
            }
        </MudContainer>
    </MudMainContent>
</MudLayout>

<style>
    /* .reader-container moved to shared Configuration */
    
    /* Pagination Arrow Fix for Dark Mode */
    [data-theme='dark'] .mud-pagination .mud-button-root {
        color: inherit !important;
    }
    [data-theme='dark'] .mud-pagination .mud-button-root .mud-icon-root {
        color: inherit !important;
        fill: currentColor !important;
    }
</style>

@code {
    private bool _isDarkMode = true;
    private MudTheme _theme = new()
    {
        PaletteLight = new PaletteLight
        {
            Background = "#00000000",
            AppbarBackground = "#00000000",
            DrawerBackground = "#00000000",
            Surface = "#00000000"
        },
        PaletteDark = new PaletteDark
        {
            Background = "#00000000",
            AppbarBackground = "#00000000",
            DrawerBackground = "#00000000",
            Surface = "#00000000"
        }
    };

    private string AppBarClass { get; set; } = "";
    private string ContainerClass { get; set; } = "";
    private Edge _startEdge = Edge.False;
    private Edge _endEdge = Edge.False;

    protected override void OnInitialized()
    {
        if (Application.Current != null)
        {
            Application.Current.RequestedThemeChanged += OnThemeChanged;
            _isDarkMode = Application.Current.RequestedTheme == AppTheme.Dark;
        }

        if (Microsoft.Maui.Devices.DeviceInfo.Platform == Microsoft.Maui.Devices.DevicePlatform.WinUI)
        {
            _startEdge = Edge.Start;
            _endEdge = Edge.End;
        }

        NavService.OnViewChanged += StateHasChanged;
        NavService.OnArticleLinkChanged += OnArticleLinkChanged;
        NavService.OnBrowserStateChanged += OnBrowserStateChanged;
        NavService.OnReaderModeChanged += OnReaderModeChanged;
        RssService.OnItemsUpdated += StateHasChanged; // Subscribe for item count updates
        RssService.OnFeedChanged += OnFeedChangedHandler; // Subscribe for active feed changes
        WeatherService.OnLocationChanged += StateHasChanged; // Subscribe for weather location changes

        if (Microsoft.Maui.Devices.DeviceInfo.Platform == Microsoft.Maui.Devices.DevicePlatform.Android ||
            Microsoft.Maui.Devices.DeviceInfo.Platform == Microsoft.Maui.Devices.DevicePlatform.iOS)
        {
            // Mobile Layout
            AppBarClass = "pt-20 pb-2";
            ContainerClass = "mt-20 pt-6 px-4 pb-0";
        }
        else
        {
            // Desktop Layout (Windows/Mac)
            AppBarClass = "pt-20 pb-2";
            ContainerClass = "mt-20 pt-6 px-4 pb-0";
        }
    }

    private async void OnThemeChanged(object? sender, AppThemeChangedEventArgs e)
    {
        _isDarkMode = e.RequestedTheme == AppTheme.Dark;
        StateHasChanged();
        // Update Theme JS is now less critical for startup but still useful for body listeners if any
        await UpdateThemeJs();
    }

    private async Task UpdateThemeJs()
    {
        var themeValue = _isDarkMode ? "dark" : "light";
        try
        {
            await JSRuntime.InvokeVoidAsync("dailyInterop.setBodyAttribute", "data-theme", themeValue);
        }
        catch (Exception) { /* Ignore */ }
    }



    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
             // Fallback: Sync body theme too just in case external scripts need it
             await UpdateThemeJs();
             
             // Initial sync
             SyncIndexFromService();
        }
        
        // Measure Toolbar Height whenever we render, to ensure we have the latest
        await UpdateToolbarHeight();
    }
    

    
    private async Task UpdateToolbarHeight()
    {
        try
        {
            var height = await JSRuntime.InvokeAsync<double>("eval", "document.querySelector('.mud-appbar')?.offsetHeight || 0");
            if (height > 0)
            {
                NavService.SetToolbarHeight(height);
            }
        }
        catch { }
    }

    public void Dispose()
    {
        NavService.OnViewChanged -= StateHasChanged;
        NavService.OnArticleLinkChanged -= StateHasChanged;
        NavService.OnBrowserStateChanged -= OnBrowserStateChanged;
        NavService.OnReaderModeChanged -= OnReaderModeChanged;
        RssService.OnItemsUpdated -= StateHasChanged;
        RssService.OnFeedChanged -= OnFeedChangedHandler;
        WeatherService.OnLocationChanged -= StateHasChanged;
        if (Application.Current != null)
        {
            Application.Current.RequestedThemeChanged -= OnThemeChanged;
        }
    }

    private void OnArticleLinkChanged()
    {
        StateHasChanged();
        _ = UpdateToolbarHeight();
    }
    
    private void OnReaderModeChanged(bool isEnabled)
    {
        StateHasChanged();
    }
    
    private void OnBrowserStateChanged(bool isOpen)
    {
        StateHasChanged();
        _ = UpdateToolbarHeight();
    }

    private async Task CopyToClipboard()
    {
        var url = NavService.CurrentArticleLink;
        if (!string.IsNullOrEmpty(url))
        {
            await Clipboard.Default.SetTextAsync(url);
            Snackbar.Add("Link copied to clipboard", Severity.Success);
        }
    }

    private void OpenInternalBrowser()
    {
        var url = NavService.CurrentArticleLink;
        if (!string.IsNullOrEmpty(url))
        {
            NavService.RequestOpenUrl(url);
        }
    }
    
    private void OnReaderModeClicked()
    {
         NavService.ToggleReaderMode();
    }
    
    private void OnBrowserCloseClicked()
    {
         NavService.SetBrowserState(false);
    }
    
    private void ToggleBrowser()
    {
        if (NavService.IsBrowserOpen)
        {
            NavService.SetBrowserState(false);
        }
        else
        {
            OpenInternalBrowser();
        }
    }

    private async Task OpenSystemBrowser()
    {
        var url = NavService.CurrentArticleLink;
        if (!string.IsNullOrEmpty(url))
        {
            try
            {
                await Launcher.Default.OpenAsync(new Uri(url));
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error opening system browser: {ex.Message}");
            }
        }
    }


    private int _selectedFeedIndex = 0;
    
    // Helper to sync carousel with service state
    private void SyncIndexFromService()
    {
        if (RssService.CurrentFeed != null)
        {
            var index = RssService.Feeds.IndexOf(RssService.CurrentFeed);
            if (index >= 0 && index != _selectedFeedIndex)
            {
                _selectedFeedIndex = index;
                StateHasChanged();
            }
        }
    }

    private void OnCarouselIndexChanged(int index)
    {
        _selectedFeedIndex = index;
        if (index >= 0 && index < RssService.Feeds.Count)
        {
            var feed = RssService.Feeds[index];
            if (RssService.CurrentFeed != feed)
            {
                RssService.SelectFeed(feed);
            }
        }
    }

    private async void OnFeedChangedHandler()
    {
        SyncIndexFromService();
        await InvokeAsync(StateHasChanged);
    }
}
