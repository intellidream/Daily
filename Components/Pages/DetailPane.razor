@using Daily.Services
@using Daily.Components.Pages
@inject IWindowManagerService WindowManager
@inject IJSRuntime JSRuntime
@inject IRefreshService RefreshService
@inject IDetailNavigationService NavService
@inject ISnackbar Snackbar
@inject IRssFeedService RssService
@implements IDisposable

<MudThemeProvider @bind-IsDarkMode="_isDarkMode" Theme="_theme" />
<MudDialogProvider />
<MudSnackbarProvider />
<MudPopoverProvider />

<MudLayout Style="background-color: transparent; min-height: 100vh; display: flex; flex-direction: column;" Class="mesh-background" UserAttributes="@(new Dictionary<string, object> { { "data-theme", _isDarkMode ? "dark" : "light" } })">
    <MudAppBar Elevation="0" Dense="true" Fixed="true" Color="Color.Transparent" Class="@AppBarClass" Style="backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); border-bottom: 1px solid rgba(255,255,255,0.1);">
        @if (!string.IsNullOrEmpty(NavService.CurrentArticleLink))
        {
            <MudIconButton Icon="@Icons.Material.Filled.ArrowBack" Color="Color.Inherit" OnClick="@(() => NavService.SetCurrentArticle(null))" Class="mr-2" />
        }
        else
        {
            <MudIconButton Icon="@Icons.Material.Filled.Refresh" Color="Color.Inherit" OnClick="@(async () => await RefreshService.TriggerDetailRefreshAsync())" Class="mr-2" />
        }

        @if (!string.IsNullOrEmpty(NavService.CurrentArticleLink))
        {
             <div style="flex: 1; min-width: 0;">
                 <MudText Typo="Typo.h6" Style="white-space: nowrap; overflow: hidden; text-overflow: ellipsis; font-weight: 700;">
                     @NavService.CurrentArticleTitle
                 </MudText>
             </div>
        }
         else if (NavService.CurrentView == "RssFeed" && RssService.CurrentFeed != null)
         {
              <div class="d-flex align-center flex-grow-1 overflow-x-auto gap-2 no-scrollbar px-2" style="mask-image: linear-gradient(to right, transparent, black 10px, black 90%, transparent);">
                  @foreach (var feed in RssService.Feeds)
                  {
                      var isSelected = RssService.CurrentFeed == feed;
                      <MudPaper Elevation="0" 
                                Class="@($"d-flex align-center px-2 py-1 rounded-pill cursor-pointer flex-shrink-0 transition-all {(isSelected ? "mud-theme-primary" : "surface-glass")}")"
                                @onclick="@(() => RssService.SelectFeed(feed))"
                                Style="@(isSelected ? "" : "background-color: rgba(128,128,128,0.1); border: 1px solid rgba(255,255,255,0.1);")">
                          
                          @if (!string.IsNullOrEmpty(feed.IconUrl))
                          {
                              <MudImage Src="@feed.IconUrl" Width="16" Height="16" Class="mr-2" ObjectFit="ObjectFit.Contain" />
                          }
                          
                          <MudText Typo="Typo.caption" Style="@(isSelected ? "font-weight: 700; color: white;" : "opacity: 0.8;")">
                              @feed.Name
                          </MudText>
                          
                          @if (isSelected && RssService.Items != null)
                          {
                              <MudChip T="string" Size="Size.Small" Variant="Variant.Text" Color="Color.Inherit" Class="ml-2 my-0 py-0" style="height: 16px; font-size: 0.7em; color: white !important;">
                                  @RssService.Items.Count
                              </MudChip>
                          }
                      </MudPaper>
                  }
              </div>
         }
        else
        {
            <MudText Typo="Typo.h6"><b>@NavService.CurrentTitle</b></MudText>
        }

        <MudSpacer />
        
        @if (!string.IsNullOrEmpty(NavService.CurrentArticleLink))
        {
            @if (NavService.IsBrowserOpen)
            {
                <!-- Browser Controls -->
                 <MudTooltip Text="Toggle Reader View">
                    <MudIconButton Icon="@Icons.Material.Filled.MenuBook" Color="@(NavService.IsReaderMode ? Color.Primary : Color.Inherit)" OnClick="OnReaderModeClicked" Class="mr-2" />
                </MudTooltip>
                
                 <MudTooltip Text="Close Browser">
                    <MudIconButton Icon="@Icons.Material.Filled.Close" Color="Color.Inherit" OnClick="OnBrowserCloseClicked" Class="mr-2" />
                </MudTooltip>
                 
                <MudTooltip Text="Open in System Browser">
                     <MudIconButton Icon="@Icons.Material.Filled.OpenInNew" Color="Color.Inherit" OnClick="OpenSystemBrowser" />
                </MudTooltip>
            }
            else
            {
                <!-- Standard RSS Controls -->
                <MudTooltip Text="Read full article">
                    <MudIconButton Icon="@Icons.Material.Filled.Web" Color="Color.Inherit" OnClick="OpenInternalBrowser" Class="mr-2" />
                </MudTooltip>
                <MudTooltip Text="Copy Link">
                    <MudIconButton Icon="@Icons.Material.Filled.ContentCopy" Color="Color.Inherit" OnClick="CopyToClipboard" />
                </MudTooltip>
                <MudTooltip Text="Open in System Browser">
                    <MudIconButton Icon="@Icons.Material.Filled.OpenInNew" Color="Color.Inherit" OnClick="OpenSystemBrowser" />
                </MudTooltip>
            }
        }

        <MudIconButton Icon="@Icons.Material.Filled.Close" Color="Color.Inherit" OnClick="@(() => WindowManager.CloseDetailWindow())" Title="Close" />
    </MudAppBar>
    <MudMainContent Class="d-flex flex-column" Style="flex-grow: 1;">
        <MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="@ContainerClass" Style="flex-grow: 1; display: flex; flex-direction: column;">
            @if (NavService.CurrentView == "SystemInfo")
            {
                <SystemInfoDetail />
            }
            else if (NavService.CurrentView == "RssFeed")
            {
                <RssFeedDetail />
            }
            else
            {
                <MudPaper Class="pa-8 glass-panel" Elevation="0" Style="min-height: 80vh;">
                    <MudText Typo="Typo.h4" GutterBottom="true">Reading Pane</MudText>
                    <MudText Typo="Typo.body1">This is the dedicated large format view for reading articles and watching content.</MudText>
                    <MudAlert Severity="Severity.Info" Class="mt-4">Select content from the main window to view it here.</MudAlert>
                </MudPaper>
            }
        </MudContainer>
    </MudMainContent>
</MudLayout>

<style>
    /* .reader-container moved to shared Configuration */
    
    /* Pagination Arrow Fix for Dark Mode */
    [data-theme='dark'] .mud-pagination .mud-button-root {
        color: inherit !important;
    }
    [data-theme='dark'] .mud-pagination .mud-button-root .mud-icon-root {
        color: inherit !important;
        fill: currentColor !important;
    }
</style>

@code {
    private bool _isDarkMode = true;
    private MudTheme _theme = new()
    {
        PaletteLight = new PaletteLight
        {
            Background = "#00000000",
            AppbarBackground = "#00000000",
            DrawerBackground = "#00000000",
            Surface = "#00000000"
        },
        PaletteDark = new PaletteDark
        {
            Background = "#00000000",
            AppbarBackground = "#00000000",
            DrawerBackground = "#00000000",
            Surface = "#00000000"
        }
    };

    private string AppBarClass { get; set; } = "";
    private string ContainerClass { get; set; } = "";

    protected override void OnInitialized()
    {
        if (Application.Current != null)
        {
            Application.Current.RequestedThemeChanged += OnThemeChanged;
            _isDarkMode = Application.Current.RequestedTheme == AppTheme.Dark;
        }

        NavService.OnViewChanged += StateHasChanged;
        NavService.OnArticleLinkChanged += OnArticleLinkChanged;
        NavService.OnBrowserStateChanged += OnBrowserStateChanged;
        NavService.OnReaderModeChanged += OnReaderModeChanged;
        RssService.OnItemsUpdated += StateHasChanged; // Subscribe for item count updates
        RssService.OnFeedChanged += OnFeedChangedHandler; // Subscribe for active feed changes

        if (Microsoft.Maui.Devices.DeviceInfo.Platform == Microsoft.Maui.Devices.DevicePlatform.Android ||
            Microsoft.Maui.Devices.DeviceInfo.Platform == Microsoft.Maui.Devices.DevicePlatform.iOS)
        {
            // Mobile Layout
            AppBarClass = "pt-20 pb-2";
            ContainerClass = "mt-20 py-6 px-4";
        }
        else
        {
            // Desktop Layout (Windows/Mac)
            AppBarClass = "pt-20 pb-2";
            ContainerClass = "mt-20 py-8 px-6";
        }
    }

    private async void OnThemeChanged(object? sender, AppThemeChangedEventArgs e)
    {
        _isDarkMode = e.RequestedTheme == AppTheme.Dark;
        StateHasChanged();
        // Update Theme JS is now less critical for startup but still useful for body listeners if any
        await UpdateThemeJs();
    }

    private async Task UpdateThemeJs()
    {
        var themeValue = _isDarkMode ? "dark" : "light";
        await JSRuntime.InvokeVoidAsync("eval", $"document.body.setAttribute('data-theme', '{themeValue}')");
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
             // Fallback: Sync body theme too just in case external scripts need it
             await UpdateThemeJs();
        }
        
        // Measure Toolbar Height whenever we render, to ensure we have the latest
        await UpdateToolbarHeight();
    }
    
    private async Task UpdateToolbarHeight()
    {
        try
        {
            var height = await JSRuntime.InvokeAsync<double>("eval", "document.querySelector('.mud-appbar')?.offsetHeight || 0");
            if (height > 0)
            {
                NavService.SetToolbarHeight(height);
            }
        }
        catch { }
    }

    public void Dispose()
    {
        NavService.OnViewChanged -= StateHasChanged;
        NavService.OnArticleLinkChanged -= StateHasChanged;
        NavService.OnBrowserStateChanged -= OnBrowserStateChanged;
        NavService.OnReaderModeChanged -= OnReaderModeChanged;
        RssService.OnItemsUpdated -= StateHasChanged;
        RssService.OnFeedChanged -= OnFeedChangedHandler;
        if (Application.Current != null)
        {
            Application.Current.RequestedThemeChanged -= OnThemeChanged;
        }
    }

    private void OnArticleLinkChanged()
    {
        StateHasChanged();
        _ = UpdateToolbarHeight();
    }
    
    private void OnReaderModeChanged(bool isEnabled)
    {
        StateHasChanged();
    }
    
    private void OnBrowserStateChanged(bool isOpen)
    {
        StateHasChanged();
        _ = UpdateToolbarHeight();
    }

    private async Task CopyToClipboard()
    {
        var url = NavService.CurrentArticleLink;
        if (!string.IsNullOrEmpty(url))
        {
            await Clipboard.Default.SetTextAsync(url);
            Snackbar.Add("Link copied to clipboard", Severity.Success);
        }
    }

    private void OpenInternalBrowser()
    {
        var url = NavService.CurrentArticleLink;
        if (!string.IsNullOrEmpty(url))
        {
            NavService.RequestOpenUrl(url);
        }
    }
    
    private void OnReaderModeClicked()
    {
         NavService.ToggleReaderMode();
    }
    
    private void OnBrowserCloseClicked()
    {
         NavService.SetBrowserState(false);
    }

    private async Task OpenSystemBrowser()
    {
        var url = NavService.CurrentArticleLink;
        if (!string.IsNullOrEmpty(url))
        {
            try
            {
                await Launcher.Default.OpenAsync(new Uri(url));
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error opening system browser: {ex.Message}");
            }
        }
    }


    private async void OnFeedChangedHandler()
    {
        await InvokeAsync(StateHasChanged);
    }
}
