@using Daily.Services
@inject IWindowManagerService WindowManager
@inject IJSRuntime JSRuntime
@implements IDisposable

<MudThemeProvider @bind-IsDarkMode="_isDarkMode" Theme="_theme" />
<MudDialogProvider />
<MudSnackbarProvider />
<MudPopoverProvider />

<MudLayout Style="background-color: transparent;">
    <MudAppBar Elevation="0" Dense="true" Fixed="true" Color="Color.Transparent" Style="backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); border-bottom: 1px solid rgba(255,255,255,0.1);">
        <MudText Typo="Typo.h6"><b>Daily - Detail View</b></MudText>
        <MudSpacer />
        <MudIconButton Icon="@Icons.Material.Filled.Close" Color="Color.Inherit" OnClick="@(() => WindowManager.CloseDetailWindow())" Title="Close" />
    </MudAppBar>
    <MudMainContent>
        <MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="pt-16 px-4">
             <MudPaper Class="pa-8 glass-panel" Elevation="0">
                <MudText Typo="Typo.h4" GutterBottom="true">Reading Pane</MudText>
                <MudText Typo="Typo.body1">This is the dedicated large format view for reading articles and watching content.</MudText>
                <MudAlert Severity="Severity.Info" Class="mt-4">Select content from the main window to view it here.</MudAlert>
             </MudPaper>
        </MudContainer>
    </MudMainContent>
</MudLayout>

@code {
    private bool _isDarkMode = true;
    private MudTheme _theme = new()
    {
        PaletteLight = new PaletteLight
        {
            Background = "#00000000",
            AppbarBackground = "#00000000",
            DrawerBackground = "#00000000",
            Surface = "#00000000"
        },
        PaletteDark = new PaletteDark
        {
            Background = "#00000000",
            AppbarBackground = "#00000000",
            DrawerBackground = "#00000000",
            Surface = "#00000000"
        }
    };

    protected override void OnInitialized()
    {
        if (Application.Current != null)
        {
            Application.Current.RequestedThemeChanged += OnThemeChanged;
            _isDarkMode = Application.Current.RequestedTheme == AppTheme.Dark;
        }
    }

    private async void OnThemeChanged(object? sender, AppThemeChangedEventArgs e)
    {
        _isDarkMode = e.RequestedTheme == AppTheme.Dark;
        StateHasChanged();
        await UpdateThemeJs();
    }

    private async Task UpdateThemeJs()
    {
        var themeValue = _isDarkMode ? "dark" : "light";
        await JSRuntime.InvokeVoidAsync("eval", $"document.body.setAttribute('data-theme', '{themeValue}')");
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await JSRuntime.InvokeVoidAsync("document.body.classList.add", "mesh-background");
            await UpdateThemeJs();
        }
    }

    public void Dispose()
    {
        if (Application.Current != null)
        {
            Application.Current.RequestedThemeChanged -= OnThemeChanged;
        }
    }
}
