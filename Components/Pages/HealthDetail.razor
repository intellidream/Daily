@page "/vitals"
@using Daily.Models.Health
@using Daily.Services.Health
@using Daily.Services
@using Daily.Components.Widgets
@inject IHealthService HealthService
@inject IRefreshService RefreshService
@inject ISyncService SyncService
@inject IWindowManagerService WindowManager

<MudGrid Spacing="4" Class="h-100 pb-4">

    <!-- LEFT COLUMN: Activity Hero -->
    <MudItem xs="12" lg="6">
        <MudPaper Class="detail-tile rounded-xl pa-4 pa-md-6 d-flex flex-column justify-center relative overflow-hidden" Elevation="3" Style="height: 100%; min-height: 300px;">
             
             <!-- Header -->
             <div class="d-flex align-center justify-space-between mb-4 mb-md-8 z-10">
                <div class="d-flex align-center gap-2">
                    <MudIcon Icon="@Icons.Material.Filled.Bolt" Color="Color.Warning" Size="Size.Large"/>
                    <MudText Typo="Typo.h4" Class="font-weight-bold">Activity</MudText>
                </div>
                <!-- Source Dot for Aggregate -->
                <div class="d-flex align-center gap-2">
                    <MudText Typo="Typo.h6" Style="opacity: 0.7;">Today</MudText>
                     <MudTooltip Text="Source: Multiple">
                        <div style="@GetSourceDotStyle("Mixed")"></div>
                    </MudTooltip>
                </div>
            </div>

            <!-- Big Metrics (Responsive Stack) -->
            <div class="d-flex flex-column flex-md-row align-center justify-space-around z-10 my-4 gap-4">
                <!-- Steps -->
                <div class="d-flex flex-column align-center relative">
                     <div style="@GetSourceDotStyle(_stepsSource); position: absolute; top: -5px; right: -5px;"></div>
                     <MudText Typo="Typo.caption" Style="opacity: 0.6; text-transform: uppercase; letter-spacing: 1px;">STEPS</MudText>
                    <MudText Typo="Typo.h3" Class="font-weight-bold">@FormatNumber(_steps)</MudText>
                </div>

                <!-- Calories Ring -->
                <div class="d-flex flex-column align-center mx-4 relative">
                     <div style="@GetSourceDotStyle(_caloriesSource); position: absolute; top: 0; right: 0; z-index: 20;"></div>
                     <MudProgressCircular Value="@GetPercent(_calories, 2500)" Size="Size.Large" Color="Color.Warning" StrokeWidth="8" Style="height: 120px; width: 120px;">
                         <div class="d-flex flex-column align-center">
                            <MudText Typo="Typo.h5" Class="font-weight-bold">@FormatNumber(_calories)</MudText>
                            <MudText Typo="Typo.caption">Kcal</MudText>
                         </div>
                     </MudProgressCircular>
                </div>

                <!-- Sleep -->
                <div class="d-flex flex-column align-center relative">
                    <div style="@GetSourceDotStyle(_sleepSource); position: absolute; top: -5px; right: -5px;"></div>
                    <MudText Typo="Typo.caption" Style="opacity: 0.6; text-transform: uppercase; letter-spacing: 1px;">SLEEP</MudText>
                    <MudText Typo="Typo.h3" Class="font-weight-bold">@FormatSleep(_sleepMinutes)</MudText>
                </div>
            </div>

            <!-- Activity Sub-Metrics -->
            <div class="d-flex justify-space-around mt-auto pa-4 rounded-xl z-10" style="background: rgba(255,255,255,0.05);">
                 <div class="d-flex flex-column align-center">
                     <MudIcon Icon="@Icons.Material.Filled.Map" Color="Color.Success" Size="Size.Small" Class="mb-1"/>
                     <MudText Typo="Typo.body1" Class="font-weight-bold">@(_distanceMeters > 0 ? Math.Round(_distanceMeters/1000.0, 2) + "km" : "--")</MudText>
                 </div>
                 <div class="d-flex flex-column align-center">
                     <MudIcon Icon="@Icons.Material.Filled.Stairs" Color="Color.Info" Size="Size.Small" Class="mb-1"/>
                     <MudText Typo="Typo.body1" Class="font-weight-bold">@(_floors > 0 ? _floors.ToString() : "--")</MudText>
                 </div>
                  <div class="d-flex flex-column align-center">
                     <MudIcon Icon="@Icons.Material.Filled.Speed" Color="Color.Warning" Size="Size.Small" Class="mb-1"/>
                     <MudText Typo="Typo.body1" Class="font-weight-bold">@(_speed > 0 ? _speed + " m/s" : "--")</MudText>
                 </div>
            </div>

            <!-- Decorative Gradient -->
            <div style="position: absolute; top: 0; right: 0; width: 100%; height: 100%; 
                        background: radial-gradient(circle at top right, rgba(255,152,0,0.15) 0%, transparent 60%); pointer-events: none;"></div>
        </MudPaper>
    </MudItem>

    <!-- RIGHT COLUMN: Vitals Grid -->
    <MudItem xs="12" lg="6">
        <MudGrid Spacing="4">
            <!-- Heart Rate -->
            <MudItem xs="6">
                <MudPaper Class="detail-tile rounded-xl pa-4 d-flex flex-column align-center justify-center relative" Elevation="3" Style="height: 140px;">
                    <div style="@GetSourceDotStyle(_bpmSource); position: absolute; top: 12px; right: 12px;"></div>
                    <MudIcon Icon="@Icons.Material.Filled.Favorite" Color="Color.Error" Class="mb-2" />
                    <MudText Typo="Typo.caption" Style="opacity: 0.6; text-transform: uppercase;">HEART RATE</MudText>
                    <MudText Typo="Typo.h5" Class="font-weight-bold">@(_bpm > 0 ? _bpm + " bpm" : "--")</MudText>
                </MudPaper>
            </MudItem>

            <!-- Weight -->
            <MudItem xs="6">
                <MudPaper Class="detail-tile rounded-xl pa-4 d-flex flex-column align-center justify-center relative" Elevation="3" Style="height: 140px;">
                    <div style="@GetSourceDotStyle(_weightSource); position: absolute; top: 12px; right: 12px;"></div>
                    <MudIcon Icon="@Icons.Material.Filled.MonitorWeight" Color="Color.Primary" Class="mb-2" />
                    <MudText Typo="Typo.caption" Style="opacity: 0.6; text-transform: uppercase;">WEIGHT</MudText>
                    <MudText Typo="Typo.h5" Class="font-weight-bold">@(_weightKg > 0 ? _weightKg + " kg" : "--")</MudText>
                </MudPaper>
            </MudItem>

            <!-- HRV -->
            <MudItem xs="6">
                <MudPaper Class="detail-tile rounded-xl pa-4 d-flex flex-column align-center justify-center relative" Elevation="3" Style="height: 140px;">
                     <div style="@GetSourceDotStyle(_hrvSource); position: absolute; top: 12px; right: 12px;"></div>
                    <MudIcon Icon="@Icons.Material.Filled.MonitorHeart" Color="Color.Secondary" Class="mb-2" />
                    <MudText Typo="Typo.caption" Style="opacity: 0.6; text-transform: uppercase;">HRV</MudText>
                    <MudText Typo="Typo.h5" Class="font-weight-bold">@(_hrv > 0 ? _hrv + " ms" : "--")</MudText>
                </MudPaper>
            </MudItem>

            <!-- Blood Pressure -->
             <MudItem xs="6">
                <MudPaper Class="detail-tile rounded-xl pa-4 d-flex flex-column align-center justify-center relative" Elevation="3" Style="height: 140px;">
                    <div style="@GetSourceDotStyle(_bpSource); position: absolute; top: 12px; right: 12px;"></div>
                    <MudIcon Icon="@Icons.Material.Filled.Compress" Color="Color.Error" Class="mb-2" />
                    <MudText Typo="Typo.caption" Style="opacity: 0.6; text-transform: uppercase;">BP</MudText>
                    <MudText Typo="Typo.h5" Class="font-weight-bold">@GetBPString()</MudText>
                </MudPaper>
            </MudItem>
            
            <!-- Body Composition Row -->
            <MudItem xs="12">
                 <MudPaper Class="detail-tile rounded-xl pa-4 d-flex align-center justify-space-around relative" Elevation="3" Style="height: 100px;">
                     <div class="d-flex flex-column align-center">
                         <MudText Typo="Typo.caption" Style="opacity: 0.6;">BODY FAT</MudText>
                         <MudText Typo="Typo.h6" Class="font-weight-bold">@(_bodyFat > 0 ? _bodyFat + "%" : "--")</MudText>
                     </div>
                     <MudDivider Vertical="true" FlexItem="true" />
                      <div class="d-flex flex-column align-center">
                         <MudText Typo="Typo.caption" Style="opacity: 0.6;">BMI</MudText>
                         <MudText Typo="Typo.h6" Class="font-weight-bold">@(_bmi > 0 ? _bmi.ToString("N1") : "--")</MudText>
                     </div>
                     <MudDivider Vertical="true" FlexItem="true" />
                      <div class="d-flex flex-column align-center">
                         <MudText Typo="Typo.caption" Style="opacity: 0.6;">LEAN MASS</MudText>
                         <MudText Typo="Typo.h6" Class="font-weight-bold">@(_leanMass > 0 ? _leanMass + "kg" : "--")</MudText>
                     </div>
                 </MudPaper>
            </MudItem>

            <!-- Sleep & Mind Row -->
             <MudItem xs="12">
                 <MudPaper Class="detail-tile rounded-xl pa-4 d-flex align-center justify-space-around relative" Elevation="3" Style="height: 100px;">
                     <div class="d-flex flex-column align-center">
                         <div style="display:flex; align-items:center; gap:4px">
                            <MudIcon Icon="@Icons.Material.Filled.SelfImprovement" Color="Color.Info" Size="Size.Small"/>
                            <MudText Typo="Typo.caption" Style="opacity: 0.6;">MIND</MudText>
                         </div>
                         <MudText Typo="Typo.h6" Class="font-weight-bold">@(_mindMinutes > 0 ? _mindMinutes + "m" : "--")</MudText>
                     </div>
                     <MudDivider Vertical="true" FlexItem="true" />
                      <div class="d-flex flex-column align-center">
                         <div style="display:flex; align-items:center; gap:4px">
                             <MudIcon Icon="@Icons.Material.Filled.DeviceThermostat" Color="Color.Warning" Size="Size.Small"/>
                             <MudText Typo="Typo.caption" Style="opacity: 0.6;">TEMP</MudText>
                         </div>
                         <MudText Typo="Typo.h6" Class="font-weight-bold">@(_temp > 0 ? _temp + "Â°C" : "--")</MudText>
                     </div>
                     <MudDivider Vertical="true" FlexItem="true" />
                      <div class="d-flex flex-column align-center">
                         <div style="display:flex; align-items:center; gap:4px">
                            <MudIcon Icon="@Icons.Material.Filled.WaterDrop" Color="Color.Primary" Size="Size.Small"/>
                            <MudText Typo="Typo.caption" Style="opacity: 0.6;">H2O</MudText>
                         </div>
                         <MudText Typo="Typo.h6" Class="font-weight-bold">@(_hydration > 0 ? _hydration + "L" : "--")</MudText>
                     </div>
                 </MudPaper>
            </MudItem>

            <!-- Nutrition Summary -->
            <MudItem xs="12">
                 <MudPaper Class="detail-tile rounded-xl pa-4 d-flex flex-column gap-2 relative" Elevation="3">
                     <!-- Macros -->
                     <div class="d-flex align-center justify-space-around mb-2">
                         <div class="d-flex flex-column align-center">
                             <MudText Typo="Typo.caption" Style="color: #4caf50;">CARBS</MudText>
                             <MudText Typo="Typo.h6" Class="font-weight-bold">@(_carbs > 0 ? _carbs + "g" : "--")</MudText>
                         </div>
                          <div class="d-flex flex-column align-center">
                             <MudText Typo="Typo.caption" Style="color: #ff9800;">PROT</MudText>
                             <MudText Typo="Typo.h6" Class="font-weight-bold">@(_prot > 0 ? _prot + "g" : "--")</MudText>
                         </div>
                          <div class="d-flex flex-column align-center">
                             <MudText Typo="Typo.caption" Style="color: #f44336;">FAT</MudText>
                             <MudText Typo="Typo.h6" Class="font-weight-bold">@(_fat > 0 ? _fat + "g" : "--")</MudText>
                         </div>
                     </div>
                     <MudDivider Light="true"/>
                     <!-- Micros -->
                     <div class="d-flex align-center justify-space-around mt-1">
                          <MudText Typo="Typo.caption" Style="opacity:0.6">Sug: @(_sugar > 0 ? _sugar+"g" : "-")</MudText>
                          <MudText Typo="Typo.caption" Style="opacity:0.6">Iron: @(_iron > 0 ? _iron+"mg" : "-")</MudText>
                          <MudText Typo="Typo.caption" Style="opacity:0.6">VitC: @(_vitC > 0 ? _vitC+"mg" : "-")</MudText>
                          <MudText Typo="Typo.caption" Style="opacity:0.6">Caff: @(_caffeine > 0 ? _caffeine+"mg" : "-")</MudText>
                     </div>
                 </MudPaper>
            </MudItem>

            <!-- Cycle Tracking (Conditional) -->
            @if (_mensFlow || _ovulationRes > 0 || _sexualActivity)
            {
                <MudItem xs="12">
                    <MudPaper Class="detail-tile rounded-xl pa-4 d-flex align-center justify-space-between relative" Elevation="3" Style="background: rgba(233, 30, 99, 0.1);">
                        <div class="d-flex align-center gap-2">
                            <MudIcon Icon="@Icons.Material.Filled.Female" Color="Color.Secondary"/>
                            <MudText Typo="Typo.h6" Color="Color.Secondary" Class="font-weight-bold">Cycle</MudText>
                        </div>
                        <div class="d-flex gap-4">
                             @if(_mensFlow) { <MudChip T="string" Size="Size.Small" Color="Color.Secondary" Variant="Variant.Filled">Flow</MudChip> }
                             @if(_ovulationRes == 1) { <MudChip T="string" Size="Size.Small" Color="Color.Info" Variant="Variant.Filled">Ovulation (+)</MudChip> }
                             @if(_sexualActivity) { <MudChip T="string" Size="Size.Small" Color="Color.Default" Variant="Variant.Outlined">Activity</MudChip> }
                        </div>
                    </MudPaper>
                </MudItem>
            }

        </MudGrid>
    </MudItem>

    <!-- Diagnostics Footer -->
    <MudItem xs="12">
        <MudExpansionPanels Elevation="0" Class="rounded-xl overflow-hidden" Style="background: transparent;">
            <MudExpansionPanel Text="Diagnostics & Sync" Style="background: rgba(255,255,255,0.05);">
                <div class="d-flex flex-column gap-2">
                     <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="ManualSync" Disabled="_isSyncing" FullWidth="true" Class="mb-2">
                        @(_isSyncing ? "Syncing..." : "Force Native Sync")
                    </MudButton>
                    <MudTextField Value="@_debugLog" Label="Sync Logs" Variant="Variant.Outlined" Lines="8" ReadOnly="true" Style="font-family: monospace; font-size: 11px;" />
                </div>
            </MudExpansionPanel>
        </MudExpansionPanels>
    </MudItem>

</MudGrid>

@implements IDisposable

@code {
    // Metrics Fields
    private double _steps, _calories, _sleepMinutes;
    private double _distanceMeters, _floors, _speed;
    private double _bpm, _rhr, _hrv, _respRate;
    private double _temp, _oxy, _bpSys, _bpDia, _glucose;
    private double _weightKg, _bodyFat, _leanMass, _height, _boneMass, _bmi;
    private double _carbs, _fat, _prot, _caffeine, _hydration, _sugar;
    private double _vitC, _vitA, _iron, _mag, _zinc, _calc;
    
    // Cycle & Mind
    private bool _mensFlow;
    private int _ovulationRes; // enum
    private bool _sexualActivity;
    private double _mindMinutes;

    // Source Fields
    private string _stepsSource, _caloriesSource, _sleepSource;
    private string _bpmSource, _weightSource, _hrvSource, _bpSource;
    private string _bodySource, _nutSource, _cycleSource; // Aggregated source flags
    
    // Diagnostics
    private string _debugLog = "";
    private bool _isSyncing = false;

    protected override async Task OnInitializedAsync()
    {
        RefreshService.RefreshRequested += LoadDataInternal;
        
        // Initial Log Load
        _debugLog = SyncService.DebugLog;
        SyncService.OnDebugLogUpdated += UpdateLog;

        await LoadDataInternal();
    }
    
    private void UpdateLog()
    {
        _debugLog = SyncService.DebugLog;
        InvokeAsync(StateHasChanged);
    }
    
    private async Task ManualSync()
    {
        if (_isSyncing) return;
        _isSyncing = true;
        StateHasChanged();
        
        try 
        {
            await HealthService.SyncNativeHealthDataAsync();
            await LoadDataInternal();
        }
        catch(Exception ex)
        {
             Console.WriteLine($"Manual Sync Failed: {ex}");
        }
        finally
        {
            _isSyncing = false;
            StateHasChanged();
        }
    }

    private async Task LoadDataInternal() => await LoadData(); 

    private async Task LoadData()
    {
         try 
        {
            await InvokeAsync(async () => 
            {
                var metrics = await HealthService.FetchMetricsAsync(DateTime.Now);

                // Activity
                (_steps, _stepsSource) = GetValAndSource(metrics, VitalType.Steps);
                (_calories, _caloriesSource) = GetValAndSource(metrics, VitalType.ActiveEnergy); 
                (_sleepMinutes, _sleepSource) = GetValAndSource(metrics, VitalType.SleepDuration);

                // Expanded Activity
                _distanceMeters = GetVal(metrics, VitalType.Distance);
                _floors = GetVal(metrics, VitalType.FloorsClimbed);
                _speed = GetVal(metrics, VitalType.WalkingSpeed);
                
                // Heart & Vitals
                (_bpm, _bpmSource) = GetValAndSource(metrics, VitalType.HeartRate);
                _rhr = GetVal(metrics, VitalType.RestingHeartRate);
                
                // HRV Priority: SDNN (iOS default) > RMSSD (Android default)
                var sdnn = GetValAndSource(metrics, VitalType.HeartRateVariabilitySDNN);
                var rmssd = GetValAndSource(metrics, VitalType.HeartRateVariabilityRMSSD);
                if (sdnn.Item1 > 0) (_hrv, _hrvSource) = sdnn;
                else (_hrv, _hrvSource) = rmssd;

                _respRate = GetVal(metrics, VitalType.RespiratoryRate);
                
                double bpSys = 0; string bpSrc = "";
                (bpSys, bpSrc) = GetValAndSource(metrics, VitalType.BloodPressureSystolic);
                _bpSys = bpSys; _bpSource = bpSrc; 
                _bpDia = GetVal(metrics, VitalType.BloodPressureDiastolic);
                
                _oxy = GetVal(metrics, VitalType.OxygenSaturation);
                _temp = GetVal(metrics, VitalType.BodyTemperature);

                // Body
                (_weightKg, _weightSource) = GetValAndSource(metrics, VitalType.Weight);
                _bodyFat = GetVal(metrics, VitalType.BodyFatPercentage);
                _leanMass = GetVal(metrics, VitalType.LeanBodyMass);
                _height = GetVal(metrics, VitalType.Height);
                _boneMass = GetVal(metrics, VitalType.BoneMass);
                
                // BMI Calculation
                if (_weightKg > 0 && _height > 0) _bmi = _weightKg / (_height * _height);
                else _bmi = 0;

                // Nutrition
                _carbs = GetVal(metrics, VitalType.Carbs);
                _fat = GetVal(metrics, VitalType.Fat);
                _prot = GetVal(metrics, VitalType.Protein);
                _caffeine = GetVal(metrics, VitalType.Caffeine);
                _sugar = GetVal(metrics, VitalType.Sugar);
                _hydration = GetVal(metrics, VitalType.Hydration);
                
                _vitC = GetVal(metrics, VitalType.VitaminC);
                _iron = GetVal(metrics, VitalType.Iron);
                _mag = GetVal(metrics, VitalType.Magnesium);
                
                // Cycle
                _mensFlow = GetVal(metrics, VitalType.MenstruationFlow) > 0;
                _sexualActivity = GetVal(metrics, VitalType.SexualActivity) > 0;
                _ovulationRes = (int)GetVal(metrics, VitalType.OvulationTest);
                
                // Mind
                _mindMinutes = GetVal(metrics, VitalType.MindfulSession);

                StateHasChanged();
            });
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading health detail: {ex}");
        }
    }

    private double GetVal(List<VitalMetric> metrics, VitalType type)
    {
         var m = metrics.FirstOrDefault(x => x.TypeString == type.ToString());
         return m?.Value ?? 0;
    }

    private (double, string) GetValAndSource(List<VitalMetric> metrics, VitalType type)
    {
         var m = metrics.FirstOrDefault(x => x.TypeString == type.ToString());
         return (m?.Value ?? 0, m?.SourceDevice ?? "");
    }

    private int GetPercent(double current, double goal)
    {
        if (goal <= 0) return 0;
        var p = (int)((current / goal) * 100);
        return Math.Min(p, 100);
    }
    
    private string FormatNumber(double val) => val >= 1000 ? (val / 1000.0).ToString("N1") + "k" : (val > 0 ? val.ToString("N0") : "--");

    private string FormatSleep(double minutes)
    {
        if (minutes <= 0) return "--";
        var ts = TimeSpan.FromMinutes(minutes);
        return $"{ts.Hours}h {ts.Minutes}m";
    }

    private string GetBPString()
    {
        if (_bpSys > 0 && _bpDia > 0) return $"{_bpSys}/{_bpDia}";
        return "--";
    }
    
    private string GetSourceDotStyle(string source)
    {
        string color = "rgba(158, 158, 158, 0.5)"; // Default Grey
        if (source == "iOS") color = "#2979FF"; // Blue
        else if (source == "Health Connect" || source == "Android") color = "#00E676"; // Green
        else if (source == "Manual") color = "#E91E63"; // Pink
        
        return $"width: 8px; height: 8px; border-radius: 50%; background-color: {color}; display: inline-block;";
    }

    public void Dispose()
    {
        RefreshService.RefreshRequested -= LoadDataInternal;
        SyncService.OnDebugLogUpdated -= UpdateLog;
    }
}
