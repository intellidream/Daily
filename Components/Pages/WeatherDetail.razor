@using Daily.Services
@using Daily.Models
@inject IWeatherService WeatherService
@inject ISettingsService SettingsService
@inject IGeolocation Geolocation
@inject IRefreshService RefreshService
@inject IJSRuntime JS

<MudGrid Spacing="4" Class="h-100 pb-4">
    @if (_isLoading)
    {
        <MudItem xs="12" Class="d-flex justify-center align-center flex-grow-1">
            <Daily.Components.Shared.AppLoadingSpinner />
        </MudItem>
    }
    else if (_errorMessage != null)
    {
         <MudItem xs="12" Class="d-flex flex-column justify-center align-center flex-grow-1">
            <MudText Color="Color.Error">@_errorMessage</MudText>
            <MudButton OnClick="@(() => LoadWeatherData(true))" Variant="Variant.Filled" Color="Color.Primary" Class="mt-2">Retry</MudButton>
        </MudItem>
    }
    else if (_currentWeather != null)
    {
        <!-- Row 1: Hero (Left) | Details 4-Pack (Right) -->
        <MudItem xs="12" lg="6">
             <MudPaper Class="detail-tile rounded-xl pa-4 d-flex flex-column align-center justify-center relative" Elevation="3" Style="height: 100%; min-height: 250px; overflow: hidden;">

                 <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="4" Class="mb-2">
                     <!-- Icon and Temp -->
                     <div class="d-flex align-center gap-4">
                         <MudImage Src="@($"https://openweathermap.org/img/wn/{_currentWeather.Weather[0].Icon}@4x.png")" Style="width: clamp(72px, 20vw, 120px); height: clamp(72px, 20vw, 120px); filter: drop-shadow(2px 4px 6px rgba(0,0,0,0.2));" />
                         <MudText Typo="Typo.h1" Style="font-size: clamp(3.5rem, 12vw, 5rem); font-weight: 700; line-height: 1;">@Math.Round(_currentWeather.Main.Temp)°</MudText>
                     </div>

                     <!-- Separator -->
                     <!-- Separator -->
                     <div style="height: clamp(50px, 10vw, 80px); width: 2px; background-color: rgba(128,128,128, 0.3); margin: 0 16px;"></div>

                     <!-- Feels Like -->
                     <div class="d-flex flex-column justify-center align-start">
                         <MudText Typo="Typo.h5" Style="font-size: clamp(1rem, 3vw, 1.5rem); font-weight: 800; opacity: 0.6; letter-spacing: 0.5px; text-transform: uppercase;">Feels Like</MudText>
                         <MudText Typo="Typo.h3" Style="font-size: clamp(2rem, 6vw, 3rem); font-weight: 600;">@Math.Round(_currentWeather.Main.FeelsLike)°</MudText>
                     </div>
                 </MudStack>
                 <MudText Typo="Typo.h4" Class="mt-2" Style="font-weight: 600; text-transform: capitalize;">@_currentWeather.Weather[0].Description</MudText>
                 <MudText Typo="Typo.h6" Class="mt-1" Style="opacity: 0.7;">H: @Math.Round(_currentWeather.Main.TempMax)°  L: @Math.Round(_currentWeather.Main.TempMin)°</MudText>
            </MudPaper>
        </MudItem>

        <MudItem xs="12" lg="6">
                <MudGrid Spacing="4">
                    <MudItem xs="6">
                        <MudPaper Class="detail-tile rounded-xl pa-4 d-flex flex-column align-center justify-center" Elevation="3" Style="height: 160px;">
                             <MudIcon Icon="@Icons.Material.Outlined.WaterDrop" Class="mb-2" Style="opacity: 0.7;" />
                             <MudText Typo="Typo.caption" Style="opacity: 0.6;">HUMIDITY</MudText>
                             <MudText Typo="Typo.h6">@_currentWeather.Main.Humidity%</MudText>
                        </MudPaper>
                    </MudItem>
                    <MudItem xs="6">
                        <MudPaper Class="detail-tile rounded-xl pa-4 d-flex flex-column align-center justify-center" Elevation="3" Style="height: 160px;">
                             <MudIcon Icon="@Icons.Material.Outlined.Air" Class="mb-2" Style="opacity: 0.7;" />
                             <MudText Typo="Typo.caption" Style="opacity: 0.6;">WIND</MudText>
                             <MudText Typo="Typo.h6">@Math.Round(_currentWeather.Wind.Speed) m/s</MudText>
                        </MudPaper>
                    </MudItem>
                    <MudItem xs="6">
                        <MudPaper Class="detail-tile rounded-xl pa-4 d-flex flex-column align-center justify-center" Elevation="3" Style="height: 160px;">
                             <MudIcon Icon="@Icons.Material.Outlined.Visibility" Class="mb-2" Style="opacity: 0.7;" />
                             <MudText Typo="Typo.caption" Style="opacity: 0.6;">VISIBILITY</MudText>
                             <MudText Typo="Typo.h6">@Math.Round(_currentWeather.Visibility / 1000.0, 1) km</MudText>
                        </MudPaper>
                    </MudItem>
                    <MudItem xs="6">
                        <MudPaper Class="detail-tile rounded-xl pa-4 d-flex flex-column align-center justify-center" Elevation="3" Style="height: 160px;">
                             <MudIcon Icon="@Icons.Material.Outlined.Speed" Class="mb-2" Style="opacity: 0.7;" />
                             <MudText Typo="Typo.caption" Style="opacity: 0.6;">PRESSURE</MudText>
                             @if (SettingsService.Settings.PressureUnit == "mmhg")
                             {
                                  <MudText Typo="Typo.h6">@Math.Round(_currentWeather.Main.Pressure * 0.750062) mmHg</MudText>
                             }
                             else if (SettingsService.Settings.PressureUnit == "inhg")
                             {
                                  <MudText Typo="Typo.h6">@Math.Round(_currentWeather.Main.Pressure * 0.02953, 2) inHg</MudText>
                             }
                             else
                             {
                                  <MudText Typo="Typo.h6">@_currentWeather.Main.Pressure hPa</MudText>
                             }
                        </MudPaper>
                    </MudItem>
                </MudGrid>
        </MudItem>

        <!-- Row 2: Hourly (Left) | Sun Times (Right) -->
        <MudItem xs="12" lg="6">
             <MudPaper Class="detail-tile rounded-xl pa-4 d-flex flex-column hourly-forecast-tile" Elevation="3">
                 <MudText Typo="Typo.h6" Class="mb-2" Style="font-weight: 700;">Hourly Forecast</MudText>
                 <div class="d-flex align-center pb-4" style="overflow-x: auto; overflow-y: hidden;">
                     <MudStack Row="true" Spacing="4">
                        @if (_forecast != null)
                        {
                            @foreach (var item in _forecast.List.Take(8)) // 8 * 3h = 24h
                            {
                                <div class="d-flex flex-column align-center" style="min-width: 60px;">
                                    <MudText Typo="Typo.body2" Style="opacity: 0.7;">@DateTime.Parse(item.DtTxt).ToString("HH:mm")</MudText>
                                    <MudImage Src="@($"https://openweathermap.org/img/wn/{item.Weather[0].Icon}@4x.png")" Width="40" Height="40" Style="filter: drop-shadow(0px 2px 4px rgba(0,0,0,0.2));" />
                                    <MudText Typo="Typo.h6" Style="font-weight: 700;">@Math.Round(item.Main.Temp)°</MudText>
                                    <MudText Typo="Typo.caption" Style="color: #60a5fa;">@(item.Pop > 0 ? $"{Math.Round(item.Pop * 100)}%" : "")</MudText>
                                </div>
                            }
                        }
                     </MudStack>
                 </div>
             </MudPaper>
        </MudItem>

        <MudItem xs="12" lg="6">
             <!-- Aligned nicely with Header "Hourly Forecast" visually by adding Spacer or Margin if needed, but Grid handles spacing -->
             <MudGrid Spacing="4" Class="h-100">
                <MudItem xs="6">
                    <MudPaper Class="detail-tile rounded-xl pa-4 d-flex flex-column align-center justify-center sun-time-tile" Elevation="3">
                         <MudIcon Icon="@Icons.Material.Outlined.WbSunny" Class="mb-2" Style="opacity: 0.7;" />
                         <MudText Typo="Typo.caption" Style="opacity: 0.6;">SUNRISE</MudText>
                         <MudText Typo="Typo.h6">@(_currentWeather.Sys.Sunrise > 0 ? DateTimeOffset.FromUnixTimeSeconds(_currentWeather.Sys.Sunrise).ToLocalTime().ToString("HH:mm") : "--:--")</MudText>
                    </MudPaper>
                </MudItem>
                 <MudItem xs="6">
                    <MudPaper Class="detail-tile rounded-xl pa-4 d-flex flex-column align-center justify-center sun-time-tile" Elevation="3">
                         <MudIcon Icon="@Icons.Material.Outlined.WbTwilight" Class="mb-2" Style="opacity: 0.7;" />
                         <MudText Typo="Typo.caption" Style="opacity: 0.6;">SUNSET</MudText>
                         <MudText Typo="Typo.h6">@(_currentWeather.Sys.Sunset > 0 ? DateTimeOffset.FromUnixTimeSeconds(_currentWeather.Sys.Sunset).ToLocalTime().ToString("HH:mm") : "--:--")</MudText>
                    </MudPaper>
                </MudItem>
             </MudGrid>
        </MudItem>
        
        <!-- Row 3: 5-Day (Left) | Map (Right) -->
        <MudItem xs="12" lg="6">
            <MudPaper Class="detail-tile rounded-xl pa-0 d-flex flex-column" Elevation="3" Style="height: 400px;">
                <div class="px-4 pt-3 pb-2">
                    <MudText Typo="Typo.h6" Style="font-weight: 700;">5-Day Forecast</MudText>
                </div>
                <div style="overflow-y: auto; flex-grow: 1;">
                    <MudList Clickable="false" DisablePadding="true" T="object">
                    @if (_dailyForecasts != null)
                    {
                        @foreach (var day in _dailyForecasts)
                        {
                            <MudListItem T="object">
                                <div class="d-flex align-center justify-space-between w-100">
                                    <MudText Typo="Typo.body1" Style="font-weight: 600; width: 60px;">@day.Date.ToString("ddd")</MudText>
                                    
                                    <div class="d-flex align-center gap-2">
                                        <MudIcon Icon="@Icons.Material.Filled.WaterDrop" Size="Size.Small" Style="color: #60a5fa;" />
                                        <MudText Typo="Typo.caption" Style="color: #60a5fa; width: 30px;">@(Math.Round(day.MaxPop * 100))%</MudText>
                                    </div>
                                    
                                    <MudImage Src="@($"https://openweathermap.org/img/wn/{day.Icon}@4x.png")" Width="40" Height="40" Style="filter: drop-shadow(0px 2px 4px rgba(0,0,0,0.2));" />
                                    
                                    <div class="d-flex align-center gap-4" style="width: 100px; justify-content: flex-end;">
                                        <MudText Typo="Typo.body1" Style="font-weight: 700;">@Math.Round(day.MaxTemp)°</MudText>
                                        <MudText Typo="Typo.body1" Style="opacity: 0.5;">@Math.Round(day.MinTemp)°</MudText>
                                    </div>
                                </div>
                            </MudListItem>
                            <MudDivider />
                        }
                    }
                </MudList>
                </div>
            </MudPaper>
        </MudItem>

        <MudItem xs="12" lg="6">
             <MudPaper Class="detail-tile rounded-xl pa-0 d-flex flex-column" Elevation="3" Style="height: 400px; overflow: hidden;">
                 <div class="px-4 pt-3 pb-2 flex-shrink-0" style="z-index: 10;">
                    <MudText Typo="Typo.h6" Style="font-weight: 700;">Precipitation Map</MudText>
                 </div>
                 <div class="flex-grow-1" style="position: relative;">
                     <div id="weatherMap" style="width: 100%; height: 100%;"></div>
                 </div>
             </MudPaper>
        </MudItem>
    }
</MudGrid>

<style>
    /* Tinted Tiles for Detail Pane (Matched to SystemInfo) - Now in app.css */
</style>

@code {
    private bool _isLoading = true;
    private string _errorMessage;
    private WeatherResponse _currentWeather;
    private ForecastResponse _forecast;
    private List<DailySummary> _dailyForecasts;

    protected override async Task OnInitializedAsync()
    {
        RefreshService.DetailRefreshRequested += HandleDetailRefresh;
        WeatherService.OnWeatherUpdated += HandleUpdate;
        await LoadWeatherData(forceRefresh: false);
    }
    
    public void Dispose()
    {
        RefreshService.DetailRefreshRequested -= HandleDetailRefresh;
        WeatherService.OnWeatherUpdated -= HandleUpdate;
    }

    private async Task HandleDetailRefresh()
    {
        await LoadWeatherData(forceRefresh: true);
    }

    private async void HandleUpdate()
    {
        // When updated from another source, just fetch cached data (forceRefresh=false)
        await LoadWeatherData(forceRefresh: false);
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (_currentWeather != null)
        {
             // We can initialize map whenever we have coordinates
             try 
             {
                 var apiKey = WeatherService.GetApiKey();
                 await JS.InvokeVoidAsync("dailyMap.initMap", "weatherMap", _currentWeather.Coord.Lat, _currentWeather.Coord.Lon, apiKey);
             }
             catch(Exception ex)
             {
                 Console.WriteLine($"Map Init Error: {ex.Message}");
             }
        }
    }

    private async Task LoadWeatherData(bool forceRefresh = false)
    {
        _isLoading = true;
        _errorMessage = null;
        StateHasChanged();

        try
        {
            // Use the centralized robust location logic
            var location = await WeatherService.GetResilientLocationAsync();

            if (location != null)
            {
                var fetchCurrent = WeatherService.GetCurrentWeatherAsync(location.Latitude, location.Longitude, forceRefresh);
                var fetchForecast = WeatherService.GetForecastAsync(location.Latitude, location.Longitude, forceRefresh);

                await Task.WhenAll(fetchCurrent, fetchForecast);

                _currentWeather = await fetchCurrent;
                if (_currentWeather != null)
                {
                    WeatherService.SetCurrentLocation(_currentWeather.Name, true); // Assuming auto-location for now
                }
                _forecast = await fetchForecast;

                if (_forecast != null)
                {
                    ProcessDailyForecast();
                }
            }
            else
            {
                _errorMessage = "Unable to determine location.";
            }
        }
        catch (Exception ex)
        {
            _errorMessage = $"Load Error: {ex.Message}";
        }
        finally
        {
            _isLoading = false;
            StateHasChanged();
        }
    }

    private void ProcessDailyForecast()
    {
        _dailyForecasts = new List<DailySummary>();

        // Group by Date (ignoring today since we have current weather, or include?)
        // Let's include tomorrow onwards for "Forecast", or Today if we want rest of day.
        // The list is every 3 hours.
        
        var grouped = _forecast.List
            .GroupBy(x => DateTime.Parse(x.DtTxt).Date)
            .OrderBy(g => g.Key)
            .Take(5); // 5 Days

        foreach (var group in grouped)
        {
            // Simple aggregation
            var min = group.Min(x => x.Main.TempMin);
            var max = group.Max(x => x.Main.TempMax);
            var maxPop = group.Max(x => x.Pop);
            
            // Pick icon from the middle of the day (noon) or max occurrence
            var noonItem = group.OrderBy(x => Math.Abs((DateTime.Parse(x.DtTxt) - group.Key.AddHours(12)).TotalHours)).FirstOrDefault();
            var icon = noonItem?.Weather.FirstOrDefault()?.Icon ?? "01d";

            _dailyForecasts.Add(new DailySummary
            {
                Date = group.Key,
                MinTemp = min,
                MaxTemp = max,
                MaxPop = maxPop,
                Icon = icon
            });
        }
    }

    private class DailySummary
    {
        public DateTime Date { get; set; }
        public double MinTemp { get; set; }
        public double MaxTemp { get; set; }
        public double MaxPop { get; set; }
        public string Icon { get; set; }
    }
}

<style>
    .hourly-forecast-tile {
        height: 190px; /* Always 190px */
        overflow-y: hidden;
    }
    
    .sun-time-tile {
        height: 160px; /* Default (Mobile) */
    }

    @@media (min-width: 1280px) {
        .sun-time-tile {
            height: 190px; /* Match Hourly on Desktop */
        }
    }
</style>
