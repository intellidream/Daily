@using Daily.Services
@using Daily.Models
@using MudBlazor
@inject IRssFeedService RssService
@inject IDetailNavigationService NavService
@inject IBackButtonService _backButtonService
@inject IRefreshService RefreshService

@implements IDisposable

<div class="d-flex flex-column" style="height: 100%; position: relative;">
    
    <!-- List View (Always rendered, hidden via CSS when reading) -->
    <div class="@(_selectedItem == null ? "d-flex flex-column" : "d-none") mx-n4" style="height: 100%; overflow: hidden;">
        @if (RssService.IsLoading)
        {
            <MudProgressLinear Color="Color.Primary" Indeterminate="true" Class="mb-2 flex-shrink-0" />
        }
        <div style="flex-grow: 1; overflow-y: auto;" class="px-4">
            <MudGrid Spacing="4">
                @if (RssService.Items != null)
                {
                    @foreach (var item in RssService.Items.Skip((_currentPage - 1) * _pageSize).Take(_pageSize))
                    {
                        <MudItem xs="12">
                            <MudPaper Class="pa-3 cursor-pointer hover-scale tile-glass rounded-xl" @onclick="@(() => OpenItem(item))">
                                <div class="d-flex gap-4">
                                    @if (!string.IsNullOrEmpty(item.ImageUrl))
                                    {
                                        <div style="flex-shrink: 0;">
                                            <MudImage Src="@item.ImageUrl" Width="@(_isMobile ? 80 : 200)" Height="@(_isMobile ? 54 : 135)" ObjectFit="ObjectFit.Cover" Class="rounded-xl elevation-2" />
                                        </div>
                                    }
                                    <div class="d-flex flex-column flex-grow-1" style="min-width: 0;">
                                        <MudTooltip Text="@item.Title" Arrow="true" Placement="Placement.Top">
                                            <MudText Typo="Typo.subtitle1" Style="font-weight: 600; line-height: 1.2;">@item.Title</MudText>
                                        </MudTooltip>
                                        <MudText Typo="Typo.caption" Class="mt-1" Style="opacity: 0.7;">@item.PublishDate.ToString("g")</MudText>
                                        @if (!string.IsNullOrEmpty(item.Description))
                                        {
                                             <MudText Typo="Typo.body2" Class="mt-2" Style="display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; opacity: 0.9;">
                                                 @((MarkupString)StripHtml(item.Description))
                                             </MudText>
                                        }
                                    </div>
                                </div>
                            </MudPaper>
                        </MudItem>
                    }
                }
            </MudGrid>
        </div>
        @if (RssService.Items != null && RssService.Items.Count > _pageSize)
        {
            <div class="d-flex justify-center py-2 flex-shrink-0 px-4">
                 <MudPagination BoundaryCount="1" MiddleCount="1" Count="@_pageCount" SelectedChanged="OnPageChanged" Selected="@_currentPage" 
                                Class="pa-2" Variant="Variant.Outlined" Size="Size.Small" ShowFirstButton="false" ShowLastButton="false" />
            </div>
        }
    </div>

    <!-- Reading Mode (Only rendered when selected) -->
    @if (_selectedItem != null)
    {
        <div class="d-flex flex-column animate-fade-in" style="height: 100%; overflow: hidden;">
            @if (NavService.IsBrowserOpen && !NavService.IsReaderMode)
            {
                 // Native WebView Overlay is handling this
                 <div class="d-flex align-center justify-center" style="height: 100%;">
                     <MudText Typo="Typo.h5" Style="opacity: 0.5;">Viewing Web Content...</MudText>
                 </div>
            }
            else
            {
                <!-- Inject Shared Readability CSS (Universal) -->
                <style>
                    @((MarkupString)Configuration.ReadabilitySettings.GetCss(_isMobile))
                </style>

                <MudSwipeArea OnSwipe="@OnSwipe" Style="flex-grow: 1; overflow: hidden; display: flex; flex-direction: column;">
                    <MudPaper Class="@(_isMobile ? "pa-3 reader-paper rounded-xl mb-4" : "pa-6 reader-paper rounded-xl mb-4")" Elevation="3" Style="flex-grow: 1; overflow-y: auto; overflow-x: hidden;">
                    <div class="reader-content" data-theme="@(_isDarkMode ? "dark" : "light")">
                        <MudText Typo="Typo.h4" GutterBottom="true" Style="font-weight: 800;">@_selectedItem.Title</MudText>
                        
                        @if (_isArticleLoading)
                        {
                            <MudProgressLinear Color="Color.Primary" Indeterminate="true" Class="mb-4" />
                        }
                        else
                        {
                             <div class="d-flex align-center mb-6 gap-2">
                                 @if (!string.IsNullOrEmpty(RssService.CurrentFeed?.IconUrl))
                                 {
                                     <MudImage Src="@RssService.CurrentFeed.IconUrl" Width="24" Height="24" />
                                 }
                                 <MudText Typo="Typo.caption">
                                     @RssService.CurrentFeed?.Name 
                                     @if (!string.IsNullOrEmpty(_selectedItem.Author))
                                     {
                                         <span> •  @_selectedItem.Author</span>
                                     } 
                                     • @_selectedItem.PublishDate.ToString("f")
                                 </MudText>
                            </div>
    
                            <!-- Featured Image (Only if NOT in Reader Mode or if desired) -->
                            @if (!string.IsNullOrEmpty(_selectedItem.ImageUrl))
                            {
                                <MudImage Src="@_selectedItem.ImageUrl" Class="rounded-xl mb-6" Style="max-width: 100%; height: auto; object-fit: contain; display: block; margin: 0 auto;" />
                            }
    
                            <div class="article-content" style="@(NavService.IsReaderMode ? "font-size: 1.2rem; line-height: 1.8;" : "")">
                                @if (!string.IsNullOrEmpty(_selectedItem.Content))
                                {
                                    @((MarkupString)_selectedItem.Content)
                                }
                                else if (!string.IsNullOrEmpty(_selectedItem.Description))
                                {
                                     @((MarkupString)_selectedItem.Description)
                                     <MudAlert Severity="Severity.Info" Class="mt-4">Full content not available in feed.</MudAlert>
                                }
                            </div>
                        }

                        @if (!NavService.IsReaderMode)
                        {
                            <div class="d-flex justify-center mt-8 mb-4">
                                <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="@(() => NavService.RequestOpenUrl(_selectedItem.Link))" StartIcon="@Icons.Material.Filled.Web">
                                    Read original article
                                </MudButton>
                            </div>
                        }
                    </div>
                </MudPaper>
                </MudSwipeArea>
            }
        </div>
    }
</div>

<style>
    .tile-glass { background-color: rgba(255, 255, 255, 0.4); backdrop-filter: blur(5px); }
    [data-theme='dark'] .tile-glass { background-color: rgba(0, 0, 0, 0.4); }

    [data-theme='light'] .reader-paper { background-color: rgba(250, 249, 246, 0.20); backdrop-filter: blur(5px); }
    [data-theme='dark'] .reader-paper { background-color: rgba(0, 0, 0, 0.3); backdrop-filter: blur(5px); }
    
    .hover-scale { transition: transform 0.2s; }
    .hover-scale:hover { transform: scale(1.01); }

    .article-content img { max-width: 100%; height: auto; border-radius: 12px; margin: 16px 0; }
    .article-content p { font-size: 1.1rem; line-height: 1.6; margin-bottom: 16px; opacity: 0.9; }
    .article-content h1, .article-content h2, .article-content h3 { font-weight: 700; margin-top: 24px; margin-bottom: 12px; }
    .article-content a { color: var(--mud-palette-primary); text-decoration: none; }
    .article-content a:hover { text-decoration: underline; }

    /* .reader-container moved to shared Configuration */
</style>

@code {
    private RssItem? _selectedItem = null;
    private bool _isArticleLoading = false;
    private bool _isMobile;
    private bool _isDarkMode;

    private int _currentPage = 1;
    private const int _pageSize = 10;
    private int _pageCount => RssService.Items != null ? (int)Math.Ceiling((double)RssService.Items.Count / _pageSize) : 0;

    protected override void OnInitialized()
    {
        _isMobile = DeviceInfo.Idiom == DeviceIdiom.Phone;
        
        if (Application.Current != null)
        {
            _isDarkMode = Application.Current.RequestedTheme == AppTheme.Dark;
            Application.Current.RequestedThemeChanged += OnThemeChanged;
        }

        RssService.OnItemsUpdated += StateHasChanged;
        RssService.OnFeedChanged += OnFeedChanged;
        NavService.OnArticleLinkChanged += OnArticleLinkChanged;
        NavService.OnBrowserStateChanged += OnBrowserStateChanged;
        NavService.OnReaderModeChanged += OnReaderModeChanged;
        RefreshService.DetailRefreshRequested += OnDetailRefresh;
        
        // Check if we were navigated to with a specific item
        if (NavService.CurrentData is RssItem item)
        {
            _ = OpenItem(item);
        }
        else if (!string.IsNullOrEmpty(NavService.CurrentArticleLink))
        {
            // Restore state if we have a link but the component was re-initialized
            var existingItem = RssService.Items.FirstOrDefault(i => i.Link == NavService.CurrentArticleLink);
            if (existingItem != null)
            {
                _ = OpenItem(existingItem);
            }
        }
    }

    private void OnThemeChanged(object? sender, AppThemeChangedEventArgs e)
    {
        _isDarkMode = e.RequestedTheme == AppTheme.Dark;
        StateHasChanged();
    }

    public void Dispose()
    {
        if (Application.Current != null)
        {
            Application.Current.RequestedThemeChanged -= OnThemeChanged;
        }
        RssService.OnItemsUpdated -= StateHasChanged;
        RssService.OnFeedChanged -= OnFeedChanged;
        NavService.OnArticleLinkChanged -= OnArticleLinkChanged;
        NavService.OnBrowserStateChanged -= OnBrowserStateChanged;
        NavService.OnReaderModeChanged -= OnReaderModeChanged;
        RefreshService.DetailRefreshRequested -= OnDetailRefresh;
        _backButtonService.Unregister(OnBackNative);
    }
    
    private void OnFeedChanged()
    {
        _currentPage = 1;
        StateHasChanged();
    }
    
    private void OnPageChanged(int page)
    {
        _currentPage = page;
        StateHasChanged();
    }
    
    private void OnBrowserStateChanged(bool isOpen)
    {
        StateHasChanged();
    }

    private void OnReaderModeChanged(bool isEnabled)
    {
        StateHasChanged();
    }

    private async Task OnDetailRefresh()
    {
        await RssService.ReloadCurrentFeedAsync();
    }

    private void OnArticleLinkChanged()
    {
        // If the service says no article is open, but we have one open, close it.
        // This handles the "Back" button in the DetailPane header.
        if (NavService.CurrentArticleLink == null && _selectedItem != null)
        {
            _selectedItem = null;
            _isArticleLoading = false;
            _backButtonService.Unregister(OnBackNative);
            StateHasChanged();
        }
    }

    private async Task OpenItem(RssItem item)
    {
        _selectedItem = item;
        _isArticleLoading = true;
        _backButtonService.Register(OnBackNative);
        NavService.SetCurrentArticle(item.Link, item.Title);
        StateHasChanged();

        // Fetch full content in background
        var fullArticle = await RssService.FetchFullArticleAsync(item.Link);
        if (fullArticle != null && !string.IsNullOrEmpty(fullArticle.Content))
        {
            _selectedItem = fullArticle;
        }

        _isArticleLoading = false;
        StateHasChanged();
    }

    private void CloseItem()
    {
        _selectedItem = null;
        _isArticleLoading = false;
        _backButtonService.Unregister(OnBackNative);
        NavService.SetCurrentArticle(null, null);
        StateHasChanged();
    }

    private bool OnBackNative()
    {
        if (_selectedItem != null)
        {
            CloseItem();
            return true;
        }
        return false;
    }

    private void OnSwipe(SwipeDirection direction)
    {
        if (direction == SwipeDirection.LeftToRight && _selectedItem != null)
        {
            CloseItem();
        }
    }

    private string StripHtml(string input)
    {
        if (string.IsNullOrEmpty(input)) return string.Empty;
        // Simple strip for the preview list
        return System.Text.RegularExpressions.Regex.Replace(input, "<.*?>", String.Empty);
    }
}
