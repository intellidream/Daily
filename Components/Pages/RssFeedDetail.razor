@using Daily.Services
@using Daily.Models
@using MudBlazor
@inject IRssFeedService RssService
@inject IDetailNavigationService NavService
@inject IBackButtonService _backButtonService
@inject IRefreshService RefreshService

@implements IDisposable

<div class="d-flex flex-column" style="height: 100%; position: relative;">
    @if (_selectedItem == null)
    {
        <!-- List View -->
        @if (RssService.IsLoading)
        {
            <MudProgressLinear Color="Color.Primary" Indeterminate="true" Class="mb-2" />
        }
        <div style="flex-grow: 1; overflow-y: auto;" class="px-2">
            <MudGrid Spacing="2">
                @foreach (var item in RssService.Items)
                {
                    <MudItem xs="12">
                        <MudPaper Class="pa-3 cursor-pointer hover-scale tile-glass" @onclick="@(() => OpenItem(item))">
                            <div class="d-flex gap-4">
                                @if (!string.IsNullOrEmpty(item.ImageUrl))
                                {
                                    <MudImage Src="@item.ImageUrl" Width="100" Height="75" ObjectFit="ObjectFit.Cover" Class="rounded" />
                                }
                                <div class="d-flex flex-column flex-grow-1" style="min-width: 0;">
                                    <MudTooltip Text="@item.Title" Arrow="true" Placement="Placement.Top">
                                        <MudText Typo="Typo.subtitle1" Style="font-weight: 600; line-height: 1.2;">@item.Title</MudText>
                                    </MudTooltip>
                                    <MudText Typo="Typo.caption" Class="mt-1" Style="opacity: 0.7;">@item.PublishDate.ToString("g")</MudText>
                                    @if (!string.IsNullOrEmpty(item.Description))
                                    {
                                         <MudText Typo="Typo.body2" Class="mt-2" Style="display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; opacity: 0.9;">
                                             @((MarkupString)StripHtml(item.Description))
                                         </MudText>
                                    }
                                </div>
                            </div>
                        </MudPaper>
                    </MudItem>
                }
            </MudGrid>
        </div>
    }
    else
    {
        <!-- Reading Mode -->
        <div class="d-flex flex-column animate-fade-in" style="height: 100%; overflow: hidden;">
            <!-- Toolbar removed, moved to DetailPane -->

            <!-- Inject Shared Readability CSS if Desktop -->
            @if (DeviceInfo.Idiom == DeviceIdiom.Desktop)
            {
                <style>
                    @((MarkupString)Configuration.ReadabilitySettings.GetCss(true))
                </style>
            }

            <MudPaper Class="pa-6 tile-glass mx-2" Style="flex-grow: 1; overflow-y: auto; overflow-x: hidden;">
                <div class="reader-content">
                    <MudText Typo="Typo.h4" GutterBottom="true" Style="font-weight: 800;">@_selectedItem.Title</MudText>
                    
                    @if (_isArticleLoading)
                    {
                        <MudProgressLinear Color="Color.Primary" Indeterminate="true" Class="mb-4" />
                    }
                    
                    <div class="d-flex align-center mb-6 gap-2">
                         @if (!string.IsNullOrEmpty(RssService.CurrentFeed?.IconUrl))
                         {
                             <MudImage Src="@RssService.CurrentFeed.IconUrl" Width="24" Height="24" />
                         }
                         <MudText Typo="Typo.caption">@RssService.CurrentFeed?.Name â€¢ @_selectedItem.PublishDate.ToString("f")</MudText>
                    </div>

                    @if (!string.IsNullOrEmpty(_selectedItem.ImageUrl))
                    {
                        <MudImage Src="@_selectedItem.ImageUrl" Class="rounded-lg mb-6" Style="max-width: 100%; height: auto; object-fit: contain; display: block; margin: 0 auto;" />
                    }

                    <div class="article-content">
                        @if (!string.IsNullOrEmpty(_selectedItem.Content))
                        {
                            @((MarkupString)_selectedItem.Content)
                        }
                        else if (!string.IsNullOrEmpty(_selectedItem.Description))
                        {
                             @((MarkupString)_selectedItem.Description)
                             <MudAlert Severity="Severity.Info" Class="mt-4">Full content not available in feed.</MudAlert>
                        }
                    </div>

                    <div class="d-flex justify-center mt-8 mb-4">
                        <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="@(() => NavService.RequestOpenUrl(_selectedItem.Link))" StartIcon="@Icons.Material.Filled.Web">
                            Read Full Article
                        </MudButton>
                    </div>
                </div>
            </MudPaper>
        </div>
    }
</div>

<style>
    .tile-glass { background-color: rgba(255, 255, 255, 0.7); backdrop-filter: blur(5px); }
    body[data-theme='dark'] .tile-glass { background-color: rgba(0, 0, 0, 0.4); }
    
    .hover-scale { transition: transform 0.2s; }
    .hover-scale:hover { transform: scale(1.01); }

    .article-content img { max-width: 100%; height: auto; border-radius: 8px; margin: 16px 0; }
    .article-content p { font-size: 1.1rem; line-height: 1.6; margin-bottom: 16px; opacity: 0.9; }
    .article-content h1, .article-content h2, .article-content h3 { font-weight: 700; margin-top: 24px; margin-bottom: 12px; }
    .article-content a { color: var(--mud-palette-primary); text-decoration: none; }
    .article-content a:hover { text-decoration: underline; }

    /* .reader-container moved to shared Configuration */
</style>

@code {
    private RssItem? _selectedItem = null;
    private bool _isArticleLoading = false;

    protected override void OnInitialized()
    {
        RssService.OnItemsUpdated += StateHasChanged;
        NavService.OnArticleLinkChanged += OnArticleLinkChanged;
        RefreshService.DetailRefreshRequested += OnDetailRefresh;
        
        // Check if we were navigated to with a specific item
        if (NavService.CurrentData is RssItem item)
        {
            _ = OpenItem(item);
        }
        else if (!string.IsNullOrEmpty(NavService.CurrentArticleLink))
        {
            // Restore state if we have a link but the component was re-initialized
            var existingItem = RssService.Items.FirstOrDefault(i => i.Link == NavService.CurrentArticleLink);
            if (existingItem != null)
            {
                _ = OpenItem(existingItem);
            }
        }
    }

    public void Dispose()
    {
        RssService.OnItemsUpdated -= StateHasChanged;
        NavService.OnArticleLinkChanged -= OnArticleLinkChanged;
        RefreshService.DetailRefreshRequested -= OnDetailRefresh;
        _backButtonService.Unregister(OnBackNative);
    }

    private async Task OnDetailRefresh()
    {
        await RssService.ReloadCurrentFeedAsync();
    }

    private void OnArticleLinkChanged()
    {
        // If the service says no article is open, but we have one open, close it.
        // This handles the "Back" button in the DetailPane header.
        if (NavService.CurrentArticleLink == null && _selectedItem != null)
        {
            _selectedItem = null;
            _isArticleLoading = false;
            _backButtonService.Unregister(OnBackNative);
            StateHasChanged();
        }
    }

    private async Task OpenItem(RssItem item)
    {
        _selectedItem = item;
        _isArticleLoading = true;
        _backButtonService.Register(OnBackNative);
        NavService.SetCurrentArticle(item.Link, item.Title);
        StateHasChanged();

        // Fetch full content in background
        var fullArticle = await RssService.FetchFullArticleAsync(item.Link);
        if (fullArticle != null && !string.IsNullOrEmpty(fullArticle.Content))
        {
            _selectedItem = fullArticle;
        }

        _isArticleLoading = false;
        StateHasChanged();
    }

    private void CloseItem()
    {
        _selectedItem = null;
        _isArticleLoading = false;
        _backButtonService.Unregister(OnBackNative);
        NavService.SetCurrentArticle(null, null);
        StateHasChanged();
    }

    private bool OnBackNative()
    {
        if (_selectedItem != null)
        {
            CloseItem();
            return true;
        }
        return false;
    }

    private string StripHtml(string input)
    {
        if (string.IsNullOrEmpty(input)) return string.Empty;
        // Simple strip for the preview list
        return System.Text.RegularExpressions.Regex.Replace(input, "<.*?>", String.Empty);
    }
}
