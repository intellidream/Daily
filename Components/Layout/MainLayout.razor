@using Daily.Services
@inject IRefreshService RefreshService
@implements IDisposable
@inherits LayoutComponentBase

<MudThemeProvider @bind-IsDarkMode="_isDarkMode" Theme="_theme" />
<MudDialogProvider />
<MudSnackbarProvider />
<MudPopoverProvider />

@inject IWindowManagerService WindowManagerService
@inject IDetailNavigationService NavService

<MudLayout Style="background-color: transparent;">
<MudAppBar Elevation="0" Dense="true" Fixed="true" Color="Color.Transparent" Class="@($"glassy-appbar {AppBarClass}")" Style="">
        <MudIconButton Icon="@AppIconPath"
                       Color="Color.Inherit"
                       Class="@(_isRefreshing ? "spin-animation" : "")"
                       OnClick="@(async () => await TriggerLocalRefresh())" />
        <MudText Class="pl-2" Typo="Typo.h5"><b>DayOne</b></MudText>
        <MudSpacer />
        
        <MudTooltip Text="@(_isDarkMode ? "Switch to Light Theme" : "Switch to Dark Theme")">
            <MudIconButton Icon="@(_isDarkMode ? Icons.Material.Filled.Brightness7 : Icons.Material.Filled.Brightness4)"
                           Color="Color.Inherit"
                           OnClick="@ToggleTheme" />
        </MudTooltip>
        
        <MudTooltip Text="Settings">
            <MudIconButton Icon="@Icons.Material.Filled.Settings"
                           Color="Color.Inherit"
                           OnClick="@(() => { NavService.NavigateTo("Settings", "Settings"); WindowManagerService.OpenDetailWindow(); })" />
        </MudTooltip>

        @if (Microsoft.Maui.Devices.DeviceInfo.Platform == Microsoft.Maui.Devices.DevicePlatform.WinUI || Microsoft.Maui.Devices.DeviceInfo.Platform == Microsoft.Maui.Devices.DevicePlatform.MacCatalyst)
        {
             <MudTooltip Text="Move to Next Display">
                 <MudIconButton Icon="@Icons.Material.Filled.Monitor" 
                                Color="Color.Inherit" 
                                OnClick="@(() => WindowManagerService.MoveMainWindowToNextDisplay())" />
             </MudTooltip>

             <MudTooltip Text="Exit Daily">
                 <MudIconButton Icon="@Icons.Material.Filled.Close" 
                                Color="Color.Inherit" 
                                OnClick="@(() => Application.Current?.Quit())" />
             </MudTooltip>
        }
    </MudAppBar>
    <MudMainContent>
        <MudContainer MaxWidth="MaxWidth.False" Class="@ContainerClass">
            @Body
        </MudContainer>
    </MudMainContent>
</MudLayout>

@inject IJSRuntime JSRuntime

@code {
    private bool _isRefreshing;
    private bool _isDarkMode = true;

    private async Task TriggerLocalRefresh()
    {
        if (_isRefreshing) return;
        _isRefreshing = true;
        StateHasChanged();
        
        await RefreshService.TriggerRefreshAsync();
        
        _isRefreshing = false;
        StateHasChanged();
    }

    private MudTheme _theme = new()
    {
        PaletteLight = new PaletteLight
        {
            Background = "#00000000",
            AppbarBackground = "#00000000",
            DrawerBackground = "#00000000",
            Surface = "#00000000"
        },
        PaletteDark = new PaletteDark
        {
            Background = "#00000000",
            AppbarBackground = "#00000000",
            DrawerBackground = "#00000000",
            Surface = "#00000000"
        }
    };

    private async Task ToggleTheme()
    {
        _isDarkMode = !_isDarkMode;
        
        var newTheme = _isDarkMode ? AppTheme.Dark : AppTheme.Light;
        if (Application.Current != null)
        {
            Application.Current.UserAppTheme = newTheme;
        }

        var themeValue = _isDarkMode ? "dark" : "light";
        try
        {
            await JSRuntime.InvokeVoidAsync("dailyInterop.setBodyAttribute", "data-theme", themeValue);
        }
        catch (Exception) { /* If JS fails/disconnected, ignore */ }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            // Set initial theme based on _isDarkMode
            var initialTheme = _isDarkMode ? "dark" : "light";
            try
            {
                await JSRuntime.InvokeVoidAsync("dailyInterop.setBodyAttribute", "data-theme", initialTheme);
            }
            catch (Exception) { /* Ignore */ }
            
            // ... (rest of the mobile/desktop class logic)

            if (Microsoft.Maui.Devices.DeviceInfo.Platform == Microsoft.Maui.Devices.DevicePlatform.Android ||
                Microsoft.Maui.Devices.DeviceInfo.Platform == Microsoft.Maui.Devices.DevicePlatform.iOS)
            {
                // On Mobile, we use the XAML background, so body should be transparent
                try
                {
                    await JSRuntime.InvokeVoidAsync("dailyInterop.addClassToBody", "transparent-background");
                }
                catch (Exception) { /* Ignore */ }
            }
            else
            {
                // On Windows/Desktop, we use the CSS background
                try
                {
                    await JSRuntime.InvokeVoidAsync("dailyInterop.addClassToBody", "mesh-background");
                }
                catch (Exception) { /* Ignore */ }
            }
        }
    }

    private string AppBarClass { get; set; } = "";
    private string ContainerClass { get; set; } = "";

    protected override void OnInitialized()
    {
        if (Application.Current != null)
        {
            // Subscribe to system theme changes
            Application.Current.RequestedThemeChanged += OnThemeChanged;
            
            // Set initial state based on current system theme
            _isDarkMode = Application.Current.RequestedTheme == AppTheme.Dark;
        }

        if (Microsoft.Maui.Devices.DeviceInfo.Platform == Microsoft.Maui.Devices.DevicePlatform.MacCatalyst)
        {
            // MacOS (Keep "Perfect" Original)
            AppBarClass = "pt-20 pb-2";
            ContainerClass = "mt-20 pt-8 px-6 pb-8";
        }
        else
        {
            // Windows & Mobile (Android/iOS)
            // Reduce horizontal padding to match Detail Views better (px-6 -> px-4)
            AppBarClass = "pt-20 pb-2";
            ContainerClass = "mt-20 pt-8 px-4 pb-8";
        }
    }

    private async void OnThemeChanged(object? sender, AppThemeChangedEventArgs e)
    {
        _isDarkMode = e.RequestedTheme == AppTheme.Dark;
        StateHasChanged();

        // Update CSS
        var themeValue = _isDarkMode ? "dark" : "light";
        try
        {
            await JSRuntime.InvokeVoidAsync("dailyInterop.setBodyAttribute", "data-theme", themeValue);
        }
        catch (Exception) { /* Ignore */ }
    }

    public void Dispose()
    {
        if (Application.Current != null)
        {
            Application.Current.RequestedThemeChanged -= OnThemeChanged;
        }
    }
    // Rocket Path Data (Body + Wings) - Scaled 1.2x and Centered manually via group transform in SVG, 
    // but here we use the raw path coordinates. 
    // Note: The menubaricon.svg had a transform on the group: transform="translate(0, 30) translate(256 256) scale(1.2) translate(-256 -256)"
    // If we want to preserve that EXACT scale/position, we need to wrap it in a group with that transform.
    // MudBlazor Icon property takes a string. If it starts with <svg, it renders it as is.
    // If it is just path data, it puts it in d="...".
    // Since we need the transform, let's stick to the full SVG definition but REMOVE the fill color to allow inheritance.
    // Simplified Path Data (Inner Content Only)
    // MudBlazor wraps this in an <svg>, so we shouldn't provide the <svg> tag ourselves.
    // We MUST use ViewBox="0 0 512 512" on the MudIconButton to make this work.
    // Correct Custom SVG for MudBlazor:
    // 1. Must start with <svg to be detected as markup.
    // 2. Must NOT have fixed width/height (so it fits the button).
    // 3. Must have correct viewBox matching the coordinates.
    // 4. Must use fill="currentColor" to inherit text color.
    private const string AppIconPath = @"<svg viewBox=""0 0 512 512"" fill=""none"" xmlns=""http://www.w3.org/2000/svg"">
      <g id=""united-rocket"" transform=""translate(0, 30) translate(256 256) scale(1.2) translate(-256 -256)"">
          <path d=""M 256 20 L 330 400 L 256 350 L 182 400 Z"" fill=""currentColor""/>
          <path d=""M 280 200 L 420 300 L 300 300 Z"" fill=""currentColor""/>
          <path d=""M 232 200 L 92 300 L 212 300 Z"" fill=""currentColor""/>
      </g>
    </svg>";
}
